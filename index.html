<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MitralVis Professional - Advanced Cardiac Surgical Training Platform</title>
    
    <!-- Three.js Core and Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        :root {
            /* Medical Color Palette */
            --tissue-red: #dc2626;
            --tissue-pink: #ec4899;
            --arterial-red: #ef4444;
            --venous-blue: #2563eb;
            --muscle-orange: #ea580c;
            --connective-purple: #9333ea;
            --leaflet-gradient: linear-gradient(135deg, #dc2626, #ec4899);
            --chordae-color: #60a5fa;
            --annulus-color: #a855f7;
            
            /* UI Colors */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --panel-bg: rgba(15, 23, 42, 0.95);
            --border-color: rgba(148, 163, 184, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            
            /* Status Colors */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: var(--text-primary);
            overflow: hidden;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Professional Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 1s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
            max-width: 600px;
        }

        .loading-heart {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            position: relative;
        }

        .heart-beat {
            width: 100%;
            height: 100%;
            background: var(--leaflet-gradient);
            position: absolute;
            transform: rotate(-45deg);
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        .heart-beat::before,
        .heart-beat::after {
            content: '';
            width: 100%;
            height: 100%;
            position: absolute;
            background: var(--leaflet-gradient);
            border-radius: 50%;
        }

        .heart-beat::before {
            top: -50px;
            left: 0;
        }

        .heart-beat::after {
            left: 50px;
            top: 0;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1) rotate(-45deg); }
            14% { transform: scale(1.1) rotate(-45deg); }
            28% { transform: scale(1) rotate(-45deg); }
            42% { transform: scale(1.1) rotate(-45deg); }
        }

        .loading-title {
            font-size: 36px;
            font-weight: 200;
            letter-spacing: -0.5px;
            margin-bottom: 10px;
            background: var(--leaflet-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .loading-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 40px;
        }

        .loading-progress {
            width: 300px;
            height: 2px;
            background: var(--bg-tertiary);
            margin: 0 auto;
            overflow: hidden;
            border-radius: 2px;
        }

        .loading-bar {
            height: 100%;
            background: var(--leaflet-gradient);
            animation: loading 3s ease-out forwards;
        }

        @keyframes loading {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        /* Main Container */
        #mainContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: radial-gradient(ellipse at center, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Professional Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 100;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .brand-logo {
            width: 50px;
            height: 50px;
            background: var(--leaflet-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
        }

        .brand-text h1 {
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .brand-text p {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Hemodynamic Metrics */
        .metrics-panel {
            display: flex;
            gap: 20px;
        }

        .metric-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 18px;
            min-width: 140px;
        }

        .metric-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .metric-value.normal { color: var(--success); }
        .metric-value.warning { color: var(--warning); }
        .metric-value.critical { color: var(--danger); }

        .metric-unit {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-tertiary);
        }

        /* Navigation Panel */
        .nav-panel {
            position: absolute;
            left: 0;
            top: 80px;
            bottom: 0;
            width: 420px;
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-panel.collapsed {
            transform: translateX(-380px);
        }

        .panel-toggle {
            position: absolute;
            right: -20px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .panel-toggle:hover {
            background: var(--bg-tertiary);
        }

        /* Tab System */
        .nav-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--leaflet-gradient);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .nav-tab.active {
            color: var(--tissue-pink);
        }

        .nav-tab.active::after {
            transform: scaleX(1);
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Search Box */
        .search-container {
            margin-bottom: 24px;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 45px 14px 18px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--tissue-pink);
            background: rgba(0, 0, 0, 0.4);
        }

        .search-icon {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }

        /* Component Groups */
        .component-group {
            margin-bottom: 24px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .group-header {
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .group-header:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        .group-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .group-icon {
            width: 36px;
            height: 36px;
            background: var(--leaflet-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .group-title {
            font-weight: 600;
            font-size: 15px;
        }

        .group-count {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .group-arrow {
            color: var(--text-tertiary);
            transition: transform 0.3s;
        }

        .component-group.expanded .group-arrow {
            transform: rotate(180deg);
        }

        .group-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .component-group.expanded .group-items {
            max-height: 2000px;
        }

        /* Component Items */
        .component-item {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }

        .component-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--leaflet-gradient);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .component-item:hover {
            background: rgba(236, 72, 153, 0.05);
            padding-left: 24px;
        }

        .component-item:hover::before {
            transform: scaleX(1);
        }

        .component-item.active {
            background: rgba(236, 72, 153, 0.1);
            border-left: 3px solid var(--tissue-pink);
        }

        .component-indicator {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            background: rgba(236, 72, 153, 0.15);
            color: var(--tissue-pink);
        }

        .component-details {
            flex: 1;
        }

        .component-name {
            font-weight: 500;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .component-description {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 6px;
        }

        .component-metrics {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .component-metric {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Information Panel */
        .info-panel {
            position: absolute;
            right: 0;
            top: 80px;
            bottom: 0;
            width: 480px;
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .info-panel.collapsed {
            transform: translateX(440px);
        }

        .info-header {
            padding: 24px 28px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border-color);
        }

        .info-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .info-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .info-content {
            flex: 1;
            overflow-y: auto;
            padding: 28px;
        }

        .info-section {
            margin-bottom: 36px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 18px;
            background: var(--leaflet-gradient);
            border-radius: 2px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            margin-bottom: 24px;
        }

        .info-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            transition: all 0.3s;
        }

        .info-card:hover {
            background: rgba(0, 0, 0, 0.4);
            border-color: var(--tissue-pink);
        }

        .info-card-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .info-card-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--tissue-pink);
            font-variant-numeric: tabular-nums;
        }

        .info-card-unit {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 4px;
        }

        .info-text {
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 18px;
        }

        .info-list {
            list-style: none;
            padding: 0;
        }

        .info-list li {
            padding-left: 28px;
            position: relative;
            margin-bottom: 14px;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        .info-list li::before {
            content: '‚ñ∏';
            position: absolute;
            left: 0;
            color: var(--tissue-pink);
        }

        /* Control Dock */
        .control-dock {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 14px 20px;
            display: flex;
            gap: 24px;
            align-items: center;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .control-group {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }

        .control-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: var(--tissue-pink);
            color: var(--tissue-pink);
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: rgba(236, 72, 153, 0.2);
            border-color: var(--tissue-pink);
            color: var(--tissue-pink);
        }

        .control-label {
            font-size: 9px;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-separator {
            width: 1px;
            height: 36px;
            background: var(--border-color);
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 4px;
        }

        .mode-btn {
            padding: 10px 18px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .mode-btn:hover {
            color: var(--text-primary);
        }

        .mode-btn.active {
            background: var(--leaflet-gradient);
            color: white;
        }

        /* Pathology Visualization */
        .pathology-controls {
            padding: 24px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .pathology-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 18px;
        }

        .pathology-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
        }

        .pathology-btn {
            padding: 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .pathology-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: var(--tissue-pink);
            color: var(--text-primary);
        }

        .pathology-btn.active {
            background: rgba(236, 72, 153, 0.2);
            border-color: var(--tissue-pink);
            color: var(--tissue-pink);
        }

        .pathology-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .pathology-description {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* Surgical Steps */
        .surgery-steps {
            list-style: none;
            padding: 0;
        }

        .surgery-step {
            padding: 18px;
            margin-bottom: 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            display: flex;
            gap: 18px;
            transition: all 0.3s;
        }

        .surgery-step.active {
            background: rgba(236, 72, 153, 0.1);
            border-color: var(--tissue-pink);
        }

        .step-number {
            width: 36px;
            height: 36px;
            background: var(--leaflet-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 500;
            font-size: 15px;
            margin-bottom: 6px;
        }

        .step-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .step-warning {
            margin-top: 10px;
            padding: 10px;
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--warning);
            border-radius: 4px;
            font-size: 12px;
            color: var(--warning);
        }

        /* Learning Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-container {
            width: 90%;
            max-width: 1400px;
            max-height: 90vh;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-sidebar {
            width: 320px;
            background: rgba(0, 0, 0, 0.3);
            border-right: 1px solid var(--border-color);
            padding: 28px;
            overflow-y: auto;
        }

        .modal-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 28px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 26px;
            font-weight: 600;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--danger);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 22px;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .modal-body {
            flex: 1;
            padding: 36px;
            overflow-y: auto;
        }

        .lesson-section {
            margin-bottom: 42px;
        }

        .lesson-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 18px;
            color: var(--tissue-pink);
        }

        .lesson-content {
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .lesson-content p {
            margin-bottom: 18px;
        }

        .lesson-highlight {
            background: rgba(236, 72, 153, 0.1);
            border-left: 3px solid var(--tissue-pink);
            padding: 18px;
            border-radius: 10px;
            margin: 24px 0;
        }

        .lesson-table {
            width: 100%;
            border-collapse: collapse;
            margin: 24px 0;
        }

        .lesson-table th,
        .lesson-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .lesson-table th {
            background: rgba(0, 0, 0, 0.3);
            font-weight: 600;
            color: var(--text-primary);
        }

        .lesson-table td {
            color: var(--text-secondary);
        }

        /* Module List */
        .module-list {
            list-style: none;
            padding: 0;
        }

        .module-item {
            padding: 14px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .module-item:hover {
            background: rgba(236, 72, 153, 0.05);
            border-color: var(--tissue-pink);
        }

        .module-item.active {
            background: rgba(236, 72, 153, 0.1);
            border-color: var(--tissue-pink);
        }

        .module-item.completed {
            border-left: 3px solid var(--success);
        }

        .module-number {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }

        .module-name {
            font-weight: 500;
            font-size: 14px;
        }

        .module-duration {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* Assessment Interface */
        .assessment-container {
            padding: 36px;
        }

        .question-header {
            margin-bottom: 36px;
        }

        .question-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .question-number {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
        }

        .question-score {
            font-size: 16px;
            font-weight: 600;
            color: var(--success);
        }

        .question-text {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 28px;
            line-height: 1.6;
        }

        .answer-options {
            list-style: none;
            padding: 0;
        }

        .answer-option {
            padding: 18px;
            margin-bottom: 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .answer-option:hover {
            background: rgba(0, 0, 0, 0.4);
            border-color: var(--tissue-pink);
        }

        .answer-option.selected {
            background: rgba(236, 72, 153, 0.1);
            border-color: var(--tissue-pink);
        }

        .answer-option.correct {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }

        .answer-option.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
        }

        .answer-indicator {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .answer-text {
            flex: 1;
        }

        .question-feedback {
            margin-top: 28px;
            padding: 18px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            display: none;
        }

        .question-feedback.show {
            display: block;
        }

        .feedback-title {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .feedback-title.correct {
            color: var(--success);
        }

        .feedback-title.incorrect {
            color: var(--danger);
        }

        .feedback-explanation {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .assessment-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 36px;
        }

        .nav-btn {
            padding: 12px 24px;
            background: var(--leaflet-gradient);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Performance Stats */
        .stats-panel {
            position: absolute;
            top: 100px;
            left: 24px;
            background: rgba(0, 0, 0, 0.8);
            padding: 14px;
            border-radius: 10px;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 12px;
            color: var(--success);
            display: none;
            z-index: 100;
        }

        .stats-panel.visible {
            display: block;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 100px;
            right: -420px;
            width: 400px;
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 18px;
            transition: right 0.3s ease;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            right: 24px;
        }

        .notification-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 10px;
        }

        .notification-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-icon.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .notification-icon.info {
            background: rgba(6, 182, 212, 0.2);
            color: var(--info);
        }

        .notification-icon.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .notification-icon.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Tooltip System */
        .tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--tissue-pink);
            border-radius: 10px;
            padding: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            color: var(--tissue-pink);
            margin-bottom: 6px;
        }

        .tooltip-content {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--leaflet-gradient);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--tissue-pink);
        }

        /* Responsive Design */
        @media (max-width: 1600px) {
            .nav-panel { width: 380px; }
            .info-panel { width: 440px; }
        }

        @media (max-width: 1400px) {
            .nav-panel { width: 340px; }
            .info-panel { width: 400px; }
            .control-dock { padding: 12px 16px; }
        }

        /* 3D Labels */
        .anatomical-label {
            position: absolute;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid var(--tissue-pink);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            pointer-events: none;
            white-space: nowrap;
            z-index: 50;
            display: none;
        }

        .anatomical-label.visible {
            display: block;
        }

        .anatomical-label::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--tissue-pink);
        }

        /* Imaging Views */
        .imaging-controls {
            padding: 24px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .imaging-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 18px;
        }

        .imaging-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
        }

        .imaging-btn {
            padding: 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .imaging-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: var(--tissue-pink);
        }

        .imaging-btn.active {
            background: rgba(236, 72, 153, 0.2);
            border-color: var(--tissue-pink);
            color: var(--tissue-pink);
        }

        .imaging-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .imaging-description {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* Simulation Controls */
        .simulation-panel {
            padding: 24px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .simulation-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 18px;
        }

        .simulation-control {
            margin-bottom: 20px;
        }

        .simulation-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .simulation-value {
            color: var(--tissue-pink);
            font-weight: 600;
        }

        .simulation-slider {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .simulation-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--tissue-pink);
            border-radius: 50%;
            cursor: pointer;
        }

        .simulation-slider::-webkit-slider-thumb:hover {
            background: var(--tissue-red);
        }

        /* Case Studies */
        .case-study-card {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .case-study-card:hover {
            background: rgba(236, 72, 153, 0.05);
            border-color: var(--tissue-pink);
        }

        .case-study-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .case-study-title {
            font-weight: 600;
            font-size: 15px;
        }

        .case-study-difficulty {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
        }

        .difficulty-beginner {
            color: var(--success);
            border: 1px solid var(--success);
        }

        .difficulty-intermediate {
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .difficulty-advanced {
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .case-study-description {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
        }

        .case-study-meta {
            display: flex;
            gap: 20px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* Loading State */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .header, .control-dock, .panel-toggle {
                display: none;
            }
            
            .nav-panel, .info-panel {
                position: static;
                width: 100%;
                background: white;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>
<body>
    <!-- Professional Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-heart">
                <div class="heart-beat"></div>
            </div>
            <h1 class="loading-title">MitralVis Professional</h1>
            <p class="loading-subtitle">Advanced Cardiac Surgical Training Platform</p>
            <div class="loading-progress">
                <div class="loading-bar"></div>
            </div>
            <p style="margin-top: 20px; color: var(--text-tertiary); font-size: 12px;">
                Initializing high-fidelity anatomical models...
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainContainer">
        <canvas id="canvas"></canvas>

        <!-- Professional Header -->
        <div class="header">
            <div class="header-brand">
                <div class="brand-logo">MV</div>
                <div class="brand-text">
                    <h1>MitralVis Professional</h1>
                    <p>Surgical Training Platform v2.0</p>
                </div>
            </div>
            <div class="metrics-panel">
                <div class="metric-card">
                    <div class="metric-label">Mean Gradient</div>
                    <div class="metric-value normal">
                        <span id="meanGradient">3.2</span>
                        <span class="metric-unit">mmHg</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">EOA</div>
                    <div class="metric-value normal">
                        <span id="valveArea">4.8</span>
                        <span class="metric-unit">cm¬≤</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">LA Pressure</div>
                    <div class="metric-value normal">
                        <span id="laPressure">12</span>
                        <span class="metric-unit">mmHg</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">MR Grade</div>
                    <div class="metric-value normal">
                        <span id="mrGrade">0</span>
                        <span class="metric-unit">/4+</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Panel -->
        <div class="nav-panel" id="navPanel">
            <div class="panel-toggle" onclick="togglePanel()">
                <span id="panelArrow">‚óÄ</span>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('anatomy')">Anatomy</button>
                <button class="nav-tab" onclick="switchTab('pathology')">Pathology</button>
                <button class="nav-tab" onclick="switchTab('surgery')">Surgery</button>
                <button class="nav-tab" onclick="switchTab('imaging')">Imaging</button>
            </div>

            <!-- Anatomy Tab -->
            <div class="tab-content active" id="anatomy-tab">
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="Search anatomical structures..." id="searchInput">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>

                <!-- Mitral Leaflets Group -->
                <div class="component-group expanded" id="leaflets-group">
                    <div class="group-header" onclick="toggleGroup('leaflets')">
                        <div class="group-info">
                            <div class="group-icon">üçÉ</div>
                            <div>
                                <div class="group-title">Mitral Valve Leaflets</div>
                                <div class="group-count">6 anatomical segments (Carpentier)</div>
                            </div>
                        </div>
                        <span class="group-arrow">‚ñº</span>
                    </div>
                    <div class="group-items">
                        <div class="component-item" data-id="a1-segment" onclick="selectComponent('a1-segment')">
                            <div class="component-indicator">A1</div>
                            <div class="component-details">
                                <div class="component-name">A1 - Anterolateral Segment</div>
                                <div class="component-description">Anterior leaflet lateral zone</div>
                                <div class="component-metrics">
                                    <span class="component-metric">üìê 8-12mm width</span>
                                    <span class="component-metric">üìç Adjacent to ALC</span>
                                </div>
                            </div>
                        </div>
                        <div class="component-item" data-id="a2-segment" onclick="selectComponent('a2-segment')">
                            <div class="component-indicator">A2</div>
                            <div class="component-details">
                                <div class="component-name">A2 - Central Anterior Segment</div>
                                <div class="component-description">Largest anterior leaflet segment</div>
                                <div class="component-metrics">
                                    <span class="component-metric">üìê 15-20mm width</span>
                                    <span class="component-metric">üí™ Primary coaptation</span>
                                </div>
                            </div>
                        </div>
                        <div class="component-item" data-id="a3-segment" onclick="selectComponent('a3-segment')">
                            <div class="component-indicator">A3</div>
                            <div class="component-details">
                                <div class="component-name">A3 - Posteromedial Segment</div>
                                <div class="component-description">Anterior leaflet medial zone</div>
                                <div class="component-metrics">
                                    <span class="component-metric">üìê 8-12mm width</span>
                                    <span class="component-metric">üìç Adjacent to PMC</span>
                                </div>
                            </div>
                        </div>
                        <div class="component-item" data-id="p1-segment" onclick="selectComponent('p1-segment')">
                            <div class="component-indicator">P1</div>
                            <div class="component-details">
                                <div class="component-name">P1 - Lateral Scallop</div>
                                <div class="component-description">Posterior leaflet lateral segment</div>
                                <div class="component-metrics">
                                    <span class="component-metric">üìê 10-15mm width</span>
                                    <span class="component-metric">üìä 20% of posterior</span>
                                </div>
                            </div>
                        </div>
                        <div class="component-item" data-id="p2-segment" onclick="selectComponent('p2-segment')">
                            <div class="component-indicator">P2</div>
                            <div class="component-details">
                                <div class="component-name">P2 - Middle Scallop</div>
                                <div class="component-description">Largest posterior scallop</div>
                                <div class="component-metrics">
                                    <span class="component-metric">üìê 15-25mm width</span>
                                    <span class="component-metric">‚ö†Ô∏è 40% of prolapses</span>
                                </div>
                            </div>
                        </div>
                        <div class="component-item" data-id="p3-segment" onclick="selectComponent('p3-segment')">
                            <div class="component-indicator">P3</div>
                            <div class="component-details">
                                <div class="component-name">P3 - Medial Scallop</div>
                                <div class="component-description">Posterior leaflet medial segment</div>
                                <div class="component-metrics">
                                    <span class="component-metric">üìê 10-15mm width</span>
                                    <span class="component-metric">üìä 20% of posterior</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subvalvular Apparatus Group -->
                <div class="component-group expanded" id="subvalvular-group">
                    <div class="group-header" onclick="toggleGroup('subvalvular')">
                        <div class="group-info">
                            <div class="group-icon">üîó</div>
                            <div>
                                <div class="group-title">Subvalvular Apparatus</div>
                                <div class="group-count">Papillary muscles & chordae tendineae</div>
                            </div>
                        </div>
                        <span class="group-arrow">‚ñº</span>
                    </div>
                    <div class="group-items">
                        <div class="component-item" data-id="anterolateral-pm" onclick="selectComponent('anterolateral-pm')">
                            <div class="component-indicator">APM</div>
                            <div class="component-details">
                                <div class="component-name">Anterolateral Papillary Muscle</div>
                                <div class="component-description">Dual blood supply (LAD + LCX)</div>
                                <div class="component-metrics">
                                    <span class="component-metric">üìè 25-35mm height</span>
                                    <span class="component-metric">ü©∏ Less ischemia risk</span>
                                </div>
                            </div>
                        </div>
                        <div class="component-item" data-id="posteromedial-pm" onclick="selectComponent('posteromedial-pm')">
                            <div class="component-indicator">PPM</div>
                            <div class="component-details">
                                <div class="component-name">Posteromedial Papillary Muscle</div>
                                <div class="component-description">Single blood supply (RCA/LCX)</div>
                                <div class="component-metrics">
                                    <span class="component-metric">üìè 25-35mm height</span>
                                    <span class="component-metric">‚ö†Ô∏è Rupture risk post-MI</span>
                                </div>
                            </div>
                        </div>
                        <div class="component-item" data-id="primary-chordae" onclick="selectComponent('primary-chordae')">
                            <div class="component-indicator">1¬∞</div>
                            <div class="component-details">
                                <div class="component-name">Primary Chordae Tendineae</div>
                                <div class="component-description">Free edge insertion</div>
                                <div class="component-metrics">
                                    <span class="component-metric">‚åÄ 0.5-1mm</span>
                                    <span class="component-metric">üîß Prevent prolapse</span>
                                </div>
                            </div>
                        </div>
                        <div class="component-item" data-id="secondary-chordae" onclick="selectComponent('secondary-chordae')">
                            <div class="component-indicator">2¬∞</div>
                            <div class="component-details">
                                <div class="component-name">Secondary (Strut) Chordae</div>
                                <div class="component-description">Rough zone insertion</div>
                                <div class="component-metrics">
                                    <span class="component-metric">‚åÄ 1-2mm</span>
                                    <span class="component-metric">üí™ 80% load bearing</span>
                                </div>
                            </div>
                        </div>
                        <div class="component-item" data-id="tertiary-chordae" onclick="selectComponent('tertiary-chordae')">
                            <div class="component-indicator">3¬∞</div>
                            <div class="component-details">
                                <div class="component-name">Tertiary (Basal) Chordae</div>
                                <div class="component-description">Posterior leaflet only</div>
                                <div class="component-metrics">
                                    <span class="component-metric">‚åÄ 1-1.5mm</span>
                                    <span class="component-metric">üîó LV-annular continuity</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Annular Complex Group -->
                <div class="component-group" id="annulus-group">
                    <div class="group-header" onclick="toggleGroup('annulus')">
                        <div class="group-info">
                            <div class="group-icon">‚≠ï</div>
                            <div>
                                <div class="group-title">Annular Complex</div>
                                <div class="group-count">Saddle-shaped fibromuscular structure</div>
                            </div>
                        </div>
                        <span class="group-arrow">‚ñº</span>
                    </div>
                    <div class="group-items">
                        <div class="component-item" data-id="mitral-annulus" onclick="selectComponent('mitral-annulus')">
                            <div class="component-indicator">MA</div>
                            <div class="component-details">
                                <div class="component-name">Mitral Annulus</div>
                                <div class="component-description">D-shaped fibromuscular ring</div>
                                <div class="component-metrics">
                                    <span class="component-metric">üìê 8-12cm circumference</span>
                                    <span class="component-metric">üéØ 20-30% systolic reduction</span>
                                </div>
                            </div>
                        </div>
                        <div class="component-item" data-id="anterolateral-commissure" onclick="selectComponent('anterolateral-commissure')">
                            <div class="component-indicator">ALC</div>
                            <div class="component-details">
                                <div class="component-name">Anterolateral Commissure</div>
                                <div class="component-description">A1-P1 junction</div>
                            </div>
                        </div>
                        <div class="component-item" data-id="posteromedial-commissure" onclick="selectComponent('posteromedial-commissure')">
                            <div class="component-indicator">PMC</div>
                            <div class="component-details">
                                <div class="component-name">Posteromedial Commissure</div>
                                <div class="component-description">A3-P3 junction</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pathology Tab -->
            <div class="tab-content" id="pathology-tab">
                <div class="pathology-controls">
                    <div class="pathology-title">Select Pathological Condition</div>
                    <div class="pathology-options">
                        <button class="pathology-btn active" onclick="showPathology('normal')">
                            <div class="pathology-name">Normal Valve</div>
                            <div class="pathology-description">Baseline anatomy</div>
                        </button>
                        <button class="pathology-btn" onclick="showPathology('p2-prolapse')">
                            <div class="pathology-name">P2 Prolapse</div>
                            <div class="pathology-description">Myxomatous degeneration</div>
                        </button>
                        <button class="pathology-btn" onclick="showPathology('rheumatic')">
                            <div class="pathology-name">Rheumatic MS</div>
                            <div class="pathology-description">Commissural fusion</div>
                        </button>
                        <button class="pathology-btn" onclick="showPathology('functional')">
                            <div class="pathology-name">Functional MR</div>
                            <div class="pathology-description">Type IIIb restriction</div>
                        </button>
                        <button class="pathology-btn" onclick="showPathology('barlow')">
                            <div class="pathology-name">Barlow Disease</div>
                            <div class="pathology-description">Bileaflet prolapse</div>
                        </button>
                        <button class="pathology-btn" onclick="showPathology('endocarditis')">
                            <div class="pathology-name">Endocarditis</div>
                            <div class="pathology-description">Vegetation & perforation</div>
                        </button>
                    </div>
                </div>
                
                <div id="pathology-details" style="padding: 24px;">
                    <h3 style="font-size: 18px; margin-bottom: 16px;">Normal Mitral Valve</h3>
                    <p style="line-height: 1.8; color: var(--text-secondary); margin-bottom: 20px;">
                        The normal mitral valve demonstrates complete coaptation during systole with no regurgitation. 
                        The anterior and posterior leaflets meet at the coaptation zone with 8-10mm of overlap. 
                        All chordae tendineae are intact with appropriate tension. The annulus maintains its saddle 
                        shape with 20-30% reduction in area during systole.
                    </p>
                    <div class="info-grid">
                        <div class="info-card">
                            <div class="info-card-label">Mean Gradient</div>
                            <div class="info-card-value">1-3 mmHg</div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-label">Valve Area</div>
                            <div class="info-card-value">4-6 cm¬≤</div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-label">Coaptation Length</div>
                            <div class="info-card-value">8-10 mm</div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-label">Tenting Height</div>
                            <div class="info-card-value"><10 mm</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Surgery Tab -->
            <div class="tab-content" id="surgery-tab">
                <div class="surgery-panel">
                    <div class="pathology-title">Surgical Repair Techniques</div>
                    <ul class="surgery-steps">
                        <li class="surgery-step active">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <div class="step-title">P2 Triangular Resection</div>
                                <div class="step-description">
                                    Remove prolapsing P2 segment with triangular excision. Mark resection margins 5mm from 
                                    prolapse edges. Excise tissue preserving <15mm posterior leaflet height. Close with 
                                    4-0 or 5-0 polypropylene continuous suture.
                                </div>
                                <div class="step-warning">
                                    ‚ö†Ô∏è Avoid excessive resection - respect 1:2 anterior:posterior leaflet ratio to prevent SAM
                                </div>
                            </div>
                        </li>
                        <li class="surgery-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <div class="step-title">Sliding Annuloplasty</div>
                                <div class="step-description">
                                    For extensive resection (>15mm): Detach P1/P3 from annulus preserving 5mm margin. 
                                    Slide segments medially to close defect. Reattach with 4-0 polypropylene. 
                                    Compress excess annulus with figure-of-8 sutures.
                                </div>
                            </div>
                        </li>
                        <li class="surgery-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <div class="step-title">Neochordae Placement</div>
                                <div class="step-description">
                                    Use Gore-Tex CV-4 (strut) or CV-5 (marginal). Place pledgeted suture through 
                                    papillary muscle head. Create loops using adjacent normal chordae as reference. 
                                    Secure at free edge with figure-of-8 knots.
                                </div>
                            </div>
                        </li>
                        <li class="surgery-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <div class="step-title">Ring Annuloplasty</div>
                                <div class="step-description">
                                    Size by anterior leaflet area (Carpentier sizer) or intercommissural distance. 
                                    Place interrupted 2-0 Ethibond sutures with pledgets. Start at anterolateral trigone. 
                                    Avoid injury to circumflex artery and coronary sinus.
                                </div>
                            </div>
                        </li>
                        <li class="surgery-step">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <div class="step-title">Edge-to-Edge Repair (Alfieri)</div>
                                <div class="step-description">
                                    For central MR jets: Approximate A2 to P2 with 4-0 polypropylene figure-of-8 suture. 
                                    Creates double orifice. Always combine with annuloplasty for durability. 
                                    Ensure residual orifice area >2.5cm¬≤.
                                </div>
                            </div>
                        </li>
                        <li class="surgery-step">
                            <div class="step-number">6</div>
                            <div class="step-content">
                                <div class="step-title">Commissuroplasty</div>
                                <div class="step-description">
                                    For commissural prolapse: Plication with 4-0 polypropylene or functional closure. 
                                    For rheumatic fusion: Sharp commissurotomy to mobility zone. Preserve commissural 
                                    chordae. Aim for 3cm opening.
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Imaging Tab -->
            <div class="tab-content" id="imaging-tab">
                <div class="imaging-controls">
                    <div class="imaging-title">Echocardiographic Views</div>
                    <div class="imaging-grid">
                        <button class="imaging-btn active" onclick="setImagingView('surgeon')">
                            <div class="imaging-name">Surgeon's View</div>
                            <div class="imaging-description">Left atrial perspective</div>
                        </button>
                        <button class="imaging-btn" onclick="setImagingView('4chamber')">
                            <div class="imaging-name">4-Chamber View</div>
                            <div class="imaging-description">Apical window</div>
                        </button>
                        <button class="imaging-btn" onclick="setImagingView('lax')">
                            <div class="imaging-name">Long-Axis View</div>
                            <div class="imaging-description">Parasternal window</div>
                        </button>
                        <button class="imaging-btn" onclick="setImagingView('sax')">
                            <div class="imaging-name">Short-Axis View</div>
                            <div class="imaging-description">Mitral level</div>
                        </button>
                        <button class="imaging-btn" onclick="setImagingView('3dtee')">
                            <div class="imaging-name">3D TEE En Face</div>
                            <div class="imaging-description">Real-time 3D</div>
                        </button>
                        <button class="imaging-btn" onclick="setImagingView('bicommissural')">
                            <div class="imaging-name">Bicommissural View</div>
                            <div class="imaging-description">60¬∞ rotation</div>
                        </button>
                    </div>
                </div>
                
                <div class="simulation-panel">
                    <div class="simulation-title">Hemodynamic Simulation</div>
                    <div class="simulation-control">
                        <div class="simulation-label">
                            <span>Heart Rate</span>
                            <span class="simulation-value" id="hrValue">70 bpm</span>
                        </div>
                        <input type="range" class="simulation-slider" id="hrSlider" min="40" max="180" value="70" oninput="updateHeartRate(this.value)">
                    </div>
                    <div class="simulation-control">
                        <div class="simulation-label">
                            <span>Afterload</span>
                            <span class="simulation-value" id="afterloadValue">Normal</span>
                        </div>
                        <input type="range" class="simulation-slider" id="afterloadSlider" min="0" max="100" value="50" oninput="updateAfterload(this.value)">
                    </div>
                    <div class="simulation-control">
                        <div class="simulation-label">
                            <span>Preload</span>
                            <span class="simulation-value" id="preloadValue">Normal</span>
                        </div>
                        <input type="range" class="simulation-slider" id="preloadSlider" min="0" max="100" value="50" oninput="updatePreload(this.value)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Information Panel -->
        <div class="info-panel" id="infoPanel">
            <div class="panel-toggle" style="left: -20px;" onclick="toggleInfoPanel()">
                <span id="infoPanelArrow">‚ñ∂</span>
            </div>
            
            <div class="info-header">
                <h2 class="info-title" id="infoTitle">Welcome to MitralVis Professional</h2>
                <p class="info-subtitle" id="infoSubtitle">Select any component for detailed information</p>
            </div>
            
            <div class="info-content" id="infoContent">
                <!-- Default content -->
                <div class="info-section">
                    <h3 class="section-title">Getting Started</h3>
                    <p class="info-text">
                        MitralVis Professional is an advanced cardiac surgical training platform designed for 
                        comprehensive education in mitral valve anatomy, pathology, and surgical techniques. 
                        Navigate through the different modules using the tabs on the left panel.
                    </p>
                    <ul class="info-list">
                        <li><strong>Anatomy:</strong> Explore detailed 3D models of all mitral valve components</li>
                        <li><strong>Pathology:</strong> Visualize common pathological conditions</li>
                        <li><strong>Surgery:</strong> Learn step-by-step repair techniques</li>
                        <li><strong>Imaging:</strong> Practice echocardiographic interpretation</li>
                    </ul>
                </div>
                
                <div class="info-section">
                    <h3 class="section-title">Keyboard Shortcuts</h3>
                    <div class="info-grid">
                        <div class="info-card">
                            <div class="info-card-label">Rotate</div>
                            <div class="info-card-value">R</div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-label">Animate</div>
                            <div class="info-card-value">A</div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-label">Labels</div>
                            <div class="info-card-value">L</div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-label">Reset</div>
                            <div class="info-card-value">Space</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-section">
                    <h3 class="section-title">Learning Objectives</h3>
                    <p class="info-text">
                        Upon completion of this training platform, you will be able to:
                    </p>
                    <ul class="info-list">
                        <li>Identify all anatomical components of the mitral valve complex</li>
                        <li>Understand Carpentier's functional classification of mitral pathology</li>
                        <li>Recognize echocardiographic features of common pathologies</li>
                        <li>Plan appropriate surgical repair techniques</li>
                        <li>Predict and prevent common complications</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Control Dock -->
        <div class="control-dock">
            <div class="control-group">
                <button class="control-btn active" id="rotateBtn" onclick="toggleRotation()">
                    <span>‚Üª</span>
                    <span class="control-label">Rotate</span>
                </button>
                <button class="control-btn" id="animateBtn" onclick="toggleAnimation()">
                    <span>‚ñ∂</span>
                    <span class="control-label">Cycle</span>
                </button>
                <button class="control-btn" id="flowBtn" onclick="toggleFlow()">
                    <span>„Ä∞</span>
                    <span class="control-label">Flow</span>
                </button>
                <button class="control-btn" id="stressBtn" onclick="toggleStress()">
                    <span>üí™</span>
                    <span class="control-label">Stress</span>
                </button>
                <button class="control-btn" id="labelsBtn" onclick="toggleLabels()">
                    <span>üè∑</span>
                    <span class="control-label">Labels</span>
                </button>
            </div>

            <div class="control-separator"></div>

            <div class="mode-selector">
                <button class="mode-btn active" onclick="setMode('explore')">Explore</button>
                <button class="mode-btn" onclick="setMode('learn')">Learn</button>
                <button class="mode-btn" onclick="setMode('assess')">Assess</button>
                <button class="mode-btn" onclick="setMode('cases')">Cases</button>
            </div>

            <div class="control-separator"></div>

            <button class="control-btn" onclick="resetView()">
                <span>‚åÇ</span>
                <span class="control-label">Reset</span>
            </button>
            <button class="control-btn" onclick="toggleStats()">
                <span>üìä</span>
                <span class="control-label">Stats</span>
            </button>
        </div>

        <!-- Performance Stats -->
        <div class="stats-panel" id="statsPanel">
            FPS: <span id="fps">60</span><br>
            Vertices: <span id="vertices">0</span><br>
            Triangles: <span id="triangles">0</span><br>
            Draw Calls: <span id="drawCalls">0</span><br>
            Memory: <span id="memory">0</span> MB
        </div>

        <!-- Learning Modal -->
        <div class="modal" id="learningModal">
            <div class="modal-container">
                <div class="modal-sidebar">
                    <h3 style="margin-bottom: 24px; color: var(--tissue-pink);">Learning Modules</h3>
                    <ul class="module-list" id="moduleList">
                        <!-- Modules will be dynamically loaded -->
                    </ul>
                </div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="modalTitle">Mitral Valve Education</h2>
                        <button class="modal-close" onclick="closeLearning()">√ó</button>
                    </div>
                    <div class="modal-body" id="learningContent">
                        <!-- Content will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessment Modal -->
        <div class="modal" id="assessmentModal">
            <div class="modal-container">
                <div class="modal-content" style="width: 100%;">
                    <div class="modal-header">
                        <h2 class="modal-title">Clinical Assessment</h2>
                        <button class="modal-close" onclick="closeAssessment()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="assessment-container" id="assessmentContent">
                            <!-- Assessment questions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cases Modal -->
        <div class="modal" id="casesModal">
            <div class="modal-container">
                <div class="modal-sidebar">
                    <h3 style="margin-bottom: 24px; color: var(--tissue-pink);">Case Studies</h3>
                    <div id="casesList">
                        <!-- Cases will be loaded here -->
                    </div>
                </div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="caseTitle">Clinical Cases</h2>
                        <button class="modal-close" onclick="closeCases()">√ó</button>
                    </div>
                    <div class="modal-body" id="caseContent">
                        <!-- Case content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tooltip -->
        <div class="tooltip" id="tooltip">
            <div class="tooltip-title">Component</div>
            <div class="tooltip-content">Hover for details</div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification">
            <div class="notification-header">
                <div class="notification-icon info">‚Ñπ</div>
                <div class="notification-content">
                    <div class="notification-title">System Ready</div>
                    <div class="notification-message">Platform initialized successfully</div>
                </div>
            </div>
        </div>

        <!-- 3D Labels (dynamically positioned) -->
        <div class="anatomical-label" id="label-a1">A1 Segment</div>
        <div class="anatomical-label" id="label-a2">A2 Segment</div>
        <div class="anatomical-label" id="label-a3">A3 Segment</div>
        <div class="anatomical-label" id="label-p1">P1 Scallop</div>
        <div class="anatomical-label" id="label-p2">P2 Scallop</div>
        <div class="anatomical-label" id="label-p3">P3 Scallop</div>
        <div class="anatomical-label" id="label-apm">Anterolateral PM</div>
        <div class="anatomical-label" id="label-ppm">Posteromedial PM</div>
    </div>

    <script>
        // MitralVis Professional - Complete Implementation
        // Advanced Cardiac Surgical Training Platform
        
        class MitralVisProfessional {
            constructor() {
                // Three.js Core
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                
                // Anatomical Models
                this.mitralValve = null;
                this.leafletSegments = {};
                this.papillaryMuscles = {};
                this.chordaeGroups = {};
                this.annulus = null;
                this.bloodFlow = null;
                
                // Visualization States
                this.selectedComponent = null;
                this.currentPathology = 'normal';
                this.currentView = 'surgeon';
                this.mode = 'explore';
                
                // Animation States
                this.rotationEnabled = true;
                this.animationEnabled = false;
                this.flowVisualization = false;
                this.stressVisualization = false;
                this.labelsVisible = false;
                
                // Animation Parameters
                this.clock = new THREE.Clock();
                this.cardiacPhase = 0;
                this.heartRate = 70;
                this.systolicFraction = 0.35;
                
                // Interaction
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                this.controls = null;
                
                // Performance
                this.frameCount = 0;
                this.lastTime = performance.now();
                
                // Medical Database
                this.componentDatabase = this.initializeComponentDatabase();
                this.learningModules = this.initializeLearningModules();
                this.assessmentQuestions = this.initializeAssessmentQuestions();
                this.clinicalCases = this.initializeClinicalCases();
                
                // Initialize application
                this.init();
            }
            
            init() {
                this.setupScene();
                this.setupLighting();
                this.createCompleteMitralValve();
                this.setupControls();
                this.setupEventListeners();
                this.initializeUI();
                this.animate();
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    this.showNotification('Welcome to MitralVis Professional', 
                        'Advanced cardiac surgical training platform loaded successfully', 'success');
                }, 3000);
            }
            
            setupScene() {
                // Scene setup
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x0f172a);
                this.scene.fog = new THREE.FogExp2(0x0f172a, 0.02);
                
                // Camera setup
                const aspect = window.innerWidth / window.innerHeight;
                this.camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
                this.camera.position.set(0, -30, 40);
                this.camera.lookAt(0, 0, 0);
                
                // Renderer setup
                this.renderer = new THREE.WebGLRenderer({
                    canvas: document.getElementById('canvas'),
                    antialias: true,
                    alpha: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                this.renderer.toneMappingExposure = 1.2;
            }
            
            setupLighting() {
                // Ambient light for base illumination
                const ambient = new THREE.AmbientLight(0x404040, 0.5);
                this.scene.add(ambient);
                
                // Main surgical light (overhead)
                const mainLight = new THREE.DirectionalLight(0xffffff, 1.0);
                mainLight.position.set(0, 50, 20);
                mainLight.castShadow = true;
                mainLight.shadow.camera.near = 0.1;
                mainLight.shadow.camera.far = 100;
                mainLight.shadow.camera.left = -40;
                mainLight.shadow.camera.right = 40;
                mainLight.shadow.camera.top = 40;
                mainLight.shadow.camera.bottom = -40;
                mainLight.shadow.mapSize.width = 4096;
                mainLight.shadow.mapSize.height = 4096;
                mainLight.shadow.bias = -0.0005;
                this.scene.add(mainLight);
                
                // Fill lights for detail
                const fillLight1 = new THREE.DirectionalLight(0x88ccff, 0.4);
                fillLight1.position.set(-30, 20, -20);
                this.scene.add(fillLight1);
                
                const fillLight2 = new THREE.DirectionalLight(0xffcc88, 0.4);
                fillLight2.position.set(30, 20, -20);
                this.scene.add(fillLight2);
                
                // Rim light for edge definition
                const rimLight = new THREE.DirectionalLight(0xff6b9d, 0.3);
                rimLight.position.set(0, -20, -30);
                this.scene.add(rimLight);
                
                // Point lights for tissue glow
                const tissueGlow1 = new THREE.PointLight(0xec4899, 0.3, 50);
                tissueGlow1.position.set(10, 5, 10);
                this.scene.add(tissueGlow1);
                
                const tissueGlow2 = new THREE.PointLight(0xec4899, 0.3, 50);
                tissueGlow2.position.set(-10, 5, 10);
                this.scene.add(tissueGlow2);
                
                // Hemisphere light for realistic ambient
                const hemiLight = new THREE.HemisphereLight(0x8888ff, 0x444444, 0.3);
                this.scene.add(hemiLight);
            }
            
            createCompleteMitralValve() {
                const valveGroup = new THREE.Group();
                valveGroup.name = 'mitralValveComplex';
                
                // Material definitions for realistic tissue
                const createTissueMaterial = (baseColor, options = {}) => {
                    return new THREE.MeshPhysicalMaterial({
                        color: baseColor,
                        metalness: 0,
                        roughness: options.roughness || 0.4,
                        clearcoat: options.clearcoat || 0.2,
                        clearcoatRoughness: 0.3,
                        transparent: true,
                        opacity: options.opacity || 0.9,
                        side: THREE.DoubleSide,
                        emissive: baseColor,
                        emissiveIntensity: options.emissiveIntensity || 0.01,
                        transmission: options.transmission || 0.1,
                        thickness: options.thickness || 1.0,
                        ior: 1.45 // Index of refraction for tissue
                    });
                };
                
                // ANTERIOR LEAFLET WITH SEGMENTS (A1, A2, A3)
                this.createAnteriorLeaflet(valveGroup, createTissueMaterial);
                
                // POSTERIOR LEAFLET WITH SCALLOPS (P1, P2, P3)
                this.createPosteriorLeaflet(valveGroup, createTissueMaterial);
                
                // PAPILLARY MUSCLES
                this.createPapillaryMuscles(valveGroup, createTissueMaterial);
                
                // CHORDAE TENDINEAE
                this.createChordaeTendineae(valveGroup, createTissueMaterial);
                
                // MITRAL ANNULUS
                this.createMitralAnnulus(valveGroup, createTissueMaterial);
                
                // BLOOD FLOW PARTICLES
                this.createBloodFlow(valveGroup);
                
                // STRESS VISUALIZATION
                this.createStressVisualization(valveGroup);
                
                this.mitralValve = valveGroup;
                this.scene.add(valveGroup);
            }
            
            createAnteriorLeaflet(parent, materialFactory) {
                const anteriorGroup = new THREE.Group();
                anteriorGroup.name = 'anteriorLeaflet';
                
                // A1 Segment - Anterolateral
                const a1Geometry = this.createLeafletSegmentGeometry(8, 10, 'a1');
                const a1Material = materialFactory(0xdc2626, { opacity: 0.85 });
                const a1Mesh = new THREE.Mesh(a1Geometry, a1Material);
                a1Mesh.name = 'a1-segment';
                a1Mesh.position.set(-8, 3, 0);
                a1Mesh.rotation.x = Math.PI / 8;
                a1Mesh.rotation.z = -Math.PI / 16;
                a1Mesh.castShadow = true;
                a1Mesh.receiveShadow = true;
                
                a1Mesh.userData = {
                    name: 'A1 - Anterolateral Segment',
                    type: 'leaflet',
                    segment: 'A1',
                    dimension: '8-12 mm',
                    surfaceArea: '1.5-2.0 cm¬≤',
                    thickness: '2-3 mm',
                    motionRange: '60-70¬∞',
                    function: 'The A1 segment forms the anterolateral portion of the anterior mitral leaflet. During systole, it coapts with P1 to seal the anterolateral commissure. It receives chordal support from both heads of the anterolateral papillary muscle.',
                    clinical: 'A1 prolapse is relatively uncommon (5-8% of cases). When present, it often occurs with P1 as commissural prolapse. Isolated A1 prolapse may indicate rheumatic disease with commissural restriction.',
                    surgical: 'Repair techniques: 1) Triangular resection (rare), 2) Neochordae with Gore-Tex CV-4/CV-5, 3) Chordal transfer from P1, 4) Edge-to-edge repair with P1 for commissural prolapse, 5) Pericardial patch for restricted leaflets.'
                };
                
                this.leafletSegments['a1-segment'] = a1Mesh;
                anteriorGroup.add(a1Mesh);
                
                // A2 Segment - Central (largest)
                const a2Geometry = this.createLeafletSegmentGeometry(15, 12, 'a2');
                const a2Material = materialFactory(0xec4899, { opacity: 0.85 });
                const a2Mesh = new THREE.Mesh(a2Geometry, a2Material);
                a2Mesh.name = 'a2-segment';
                a2Mesh.position.set(0, 4, 0);
                a2Mesh.rotation.x = Math.PI / 6;
                a2Mesh.castShadow = true;
                a2Mesh.receiveShadow = true;
                
                a2Mesh.userData = {
                    name: 'A2 - Central Anterior Segment',
                    type: 'leaflet',
                    segment: 'A2',
                    dimension: '15-20 mm',
                    surfaceArea: '3.0-4.0 cm¬≤',
                    thickness: '2-3 mm',
                    motionRange: '70-80¬∞',
                    function: 'A2 is the largest segment of the anterior leaflet and the primary coaptation zone with P2. It contains the clear zone (smooth area) and rough zone (chordal attachments). Multiple secondary chordae provide structural support.',
                    clinical: 'A2 prolapse accounts for 10-15% of degenerative disease. Common site of SAM in HOCM and post-repair. Frequently affected in rheumatic disease with thickening. Endocarditic perforations common due to high stress.',
                    surgical: 'Repair strategies: 1) Limited triangular resection, 2) Multiple neochordae to distribute stress, 3) Chordal transfer (flip-over), 4) Plication for small prolapses, 5) Alfieri stitch for central jets. Maintain coaptation >8mm, avoid angle >30¬∞ to prevent SAM.'
                };
                
                this.leafletSegments['a2-segment'] = a2Mesh;
                anteriorGroup.add(a2Mesh);
                
                // A3 Segment - Posteromedial
                const a3Geometry = this.createLeafletSegmentGeometry(8, 10, 'a3');
                const a3Material = materialFactory(0xdc2626, { opacity: 0.85 });
                const a3Mesh = new THREE.Mesh(a3Geometry, a3Material);
                a3Mesh.name = 'a3-segment';
                a3Mesh.position.set(8, 3, 0);
                a3Mesh.rotation.x = Math.PI / 8;
                a3Mesh.rotation.z = Math.PI / 16;
                a3Mesh.castShadow = true;
                a3Mesh.receiveShadow = true;
                
                a3Mesh.userData = {
                    name: 'A3 - Posteromedial Segment',
                    type: 'leaflet',
                    segment: 'A3',
                    dimension: '8-12 mm',
                    surfaceArea: '1.5-2.0 cm¬≤',
                    thickness: '2-3 mm',
                    motionRange: '60-70¬∞',
                    function: 'A3 forms the posteromedial portion of the anterior leaflet, participating in the posteromedial commissure with P3. Adjacent to the aorto-mitral continuity and membranous septum.',
                    clinical: 'A3 pathology less common but significant. Vulnerable in posteromedial papillary muscle rupture. Common site for paravalvular leaks after MVR due to proximity to trigones.',
                    surgical: 'Repair techniques: 1) Commissural plication, 2) Commissurotomy for fusion, 3) Neochordae to posteromedial PM, 4) Sliding plasty for restriction, 5) Patch augmentation. Avoid conduction system injury (AV node nearby).'
                };
                
                this.leafletSegments['a3-segment'] = a3Mesh;
                anteriorGroup.add(a3Mesh);
                
                parent.add(anteriorGroup);
            }
            
            createPosteriorLeaflet(parent, materialFactory) {
                const posteriorGroup = new THREE.Group();
                posteriorGroup.name = 'posteriorLeaflet';
                
                // P1 Scallop - Lateral
                const p1Geometry = this.createScallopGeometry(10, 8, 'p1');
                const p1Material = materialFactory(0xc44569, { opacity: 0.85 });
                const p1Mesh = new THREE.Mesh(p1Geometry, p1Material);
                p1Mesh.name = 'p1-segment';
                p1Mesh.position.set(-8, -3, 0);
                p1Mesh.rotation.x = -Math.PI / 8;
                p1Mesh.rotation.z = Math.PI / 16;
                p1Mesh.castShadow = true;
                p1Mesh.receiveShadow = true;
                
                p1Mesh.userData = {
                    name: 'P1 - Lateral Scallop',
                    type: 'leaflet',
                    segment: 'P1',
                    dimension: '10-15 mm',
                    surfaceArea: '1.8-2.5 cm¬≤',
                    thickness: '1-2 mm',
                    motionRange: '40-50¬∞',
                    function: 'P1 is the lateral scallop of the posterior leaflet, comprising ~20% of its area. Forms anterolateral commissure with A1. Has distinct primary, secondary, and tertiary chordae.',
                    clinical: 'P1 prolapse in 10-15% of posterior prolapse cases. May be isolated or with commissural involvement. Less affected than P2 in myxomatous degeneration.',
                    surgical: 'Repair options: 1) Limited triangular/quadrangular resection, 2) Neochordae respecting scallop independence, 3) Commissural plication, 4) Sliding plasty if >15mm resection, 5) Cleft closure P1-P2. Maintain height <15mm.'
                };
                
                this.leafletSegments['p1-segment'] = p1Mesh;
                posteriorGroup.add(p1Mesh);
                
                // P2 Scallop - Middle (largest)
                const p2Geometry = this.createScallopGeometry(18, 10, 'p2');
                const p2Material = materialFactory(0xec4899, { opacity: 0.85 });
                const p2Mesh = new THREE.Mesh(p2Geometry, p2Material);
                p2Mesh.name = 'p2-segment';
                p2Mesh.position.set(0, -4, 0);
                p2Mesh.rotation.x = -Math.PI / 6;
                p2Mesh.castShadow = true;
                p2Mesh.receiveShadow = true;
                
                p2Mesh.userData = {
                    name: 'P2 - Middle Scallop',
                    type: 'leaflet',
                    segment: 'P2',
                    dimension: '15-25 mm',
                    surfaceArea: '3.0-4.0 cm¬≤',
                    thickness: '1-2 mm',
                    motionRange: '50-60¬∞',
                    function: 'P2 is the largest posterior scallop (40-60% of area), directly opposing A2. Has extensive chordal apparatus (10-20 chordae) from both papillary muscles. Bears highest mechanical stress.',
                    clinical: 'Most common prolapse site (40% of all, 70% of posterior). Fibroelastic deficiency causes isolated P2 prolapse. Barlow\'s involves excessive tissue. P2 flail from rupture is leading cause for surgery.',
                    surgical: 'Gold standard repair: 1) Triangular resection (<20mm), 2) Quadrangular + sliding (>20mm), 3) Neochordae loop technique, 4) Respect 1cm rule for height, 5) Folding plasty for excess. Success >95% in experienced centers.'
                };
                
                this.leafletSegments['p2-segment'] = p2Mesh;
                posteriorGroup.add(p2Mesh);
                
                // P3 Scallop - Medial
                const p3Geometry = this.createScallopGeometry(10, 8, 'p3');
                const p3Material = materialFactory(0xc44569, { opacity: 0.85 });
                const p3Mesh = new THREE.Mesh(p3Geometry, p3Material);
                p3Mesh.name = 'p3-segment';
                p3Mesh.position.set(8, -3, 0);
                p3Mesh.rotation.x = -Math.PI / 8;
                p3Mesh.rotation.z = -Math.PI / 16;
                p3Mesh.castShadow = true;
                p3Mesh.receiveShadow = true;
                
                p3Mesh.userData = {
                    name: 'P3 - Medial Scallop',
                    type: 'leaflet',
                    segment: 'P3',
                    dimension: '10-15 mm',
                    surfaceArea: '1.8-2.5 cm¬≤',
                    thickness: '1-2 mm',
                    motionRange: '40-50¬∞',
                    function: 'P3 forms the medial scallop (~20% of area), participating in posteromedial commissure with A3. Receives chordae primarily from posteromedial PM. Has unique basal chordae.',
                    clinical: 'P3 prolapse in 10-15% of posterior prolapse. Associated with posteromedial PM dysfunction. Vulnerable in inferior MI. May be restricted in ischemic MR.',
                    surgical: 'Repair strategies: 1) Limited resection preserving commissure, 2) Neochordae to posteromedial PM, 3) Commissural plication, 4) Sliding plasty, 5) Patch for restriction. Consider PM repositioning in ischemic MR.'
                };
                
                this.leafletSegments['p3-segment'] = p3Mesh;
                posteriorGroup.add(p3Mesh);
                
                parent.add(posteriorGroup);
            }
            
            createPapillaryMuscles(parent, materialFactory) {
                // Anterolateral Papillary Muscle
                const apmGeometry = this.createPapillaryMuscleGeometry('anterolateral');
                const apmMaterial = materialFactory(0xea580c, { 
                    roughness: 0.5, 
                    opacity: 0.9 
                });
                const apmMesh = new THREE.Mesh(apmGeometry, apmMaterial);
                apmMesh.name = 'anterolateral-pm';
                apmMesh.position.set(-6, -12, 2);
                apmMesh.castShadow = true;
                apmMesh.receiveShadow = true;
                
                apmMesh.userData = {
                    name: 'Anterolateral Papillary Muscle',
                    type: 'muscle',
                    height: '25-35 mm',
                    baseWidth: '10-15 mm',
                    heads: '1-2 (usually single)',
                    bloodSupply: 'Dual (LAD diagonals + LCX marginals)',
                    function: 'Provides chordae to anterolateral half of both leaflets (A1, lateral A2, P1, lateral P2). Contracts during systole maintaining chordal tension. Dual blood supply provides ischemic protection.',
                    clinical: 'Less prone to rupture (<5% of PM ruptures). Elongation in myxomatous disease causes prolapse. Fibrosis in rheumatic disease. Hypertrophy in HOCM contributes to SAM.',
                    surgical: 'Techniques: 1) PM repositioning (Messas) for functional MR, 2) Reimplantation after rupture, 3) Artificial chordae origination point, 4) PM approximation (Hvass), 5) Avoid damage during VSD repair.'
                };
                
                this.papillaryMuscles['anterolateral-pm'] = apmMesh;
                parent.add(apmMesh);
                
                // Posteromedial Papillary Muscle
                const ppmGeometry = this.createPapillaryMuscleGeometry('posteromedial');
                const ppmMaterial = materialFactory(0xdc2626, { 
                    roughness: 0.5, 
                    opacity: 0.9 
                });
                const ppmMesh = new THREE.Mesh(ppmGeometry, ppmMaterial);
                ppmMesh.name = 'posteromedial-pm';
                ppmMesh.position.set(6, -12, 2);
                ppmMesh.castShadow = true;
                ppmMesh.receiveShadow = true;
                
                ppmMesh.userData = {
                    name: 'Posteromedial Papillary Muscle',
                    type: 'muscle',
                    height: '25-35 mm',
                    baseWidth: '10-15 mm',
                    heads: '2-3 (often bifid)',
                    bloodSupply: 'Single (RCA 85% or LCX 15%)',
                    function: 'Provides chordae to posteromedial half of leaflets (A3, medial A2, P3, medial P2). Often has multiple heads. Single blood supply makes it vulnerable to ischemia.',
                    clinical: 'Common rupture site (95% of PM ruptures) in inferior MI. Complete rupture causes acute severe MR and shock (>50% mortality without surgery). Partial rupture causes chronic ischemic MR.',
                    surgical: 'Critical approaches: 1) Emergency reimplantation for rupture, 2) Neochordae to viable head, 3) Consider replacement if extensive necrosis, 4) PM sling for ischemic MR, 5) Combined CABG for revascularization.'
                };
                
                this.papillaryMuscles['posteromedial-pm'] = ppmMesh;
                parent.add(ppmMesh);
            }
            
            createChordaeTendineae(parent, materialFactory) {
                const chordaeGroup = new THREE.Group();
                chordaeGroup.name = 'chordaeTendineae';
                
                // Primary (marginal) chordae - thin, numerous
                const primaryMaterial = materialFactory(0x60a5fa, { 
                    opacity: 0.7,
                    roughness: 0.2
                });
                
                // Create primary chordae for each segment
                const segments = ['a1', 'a2', 'a3', 'p1', 'p2', 'p3'];
                segments.forEach(segment => {
                    for (let i = 0; i < 4; i++) {
                        const chord = this.createSingleChord(
                            this.getSegmentPosition(segment),
                            this.getPapillaryPosition(segment),
                            0.05, // thin diameter
                            primaryMaterial
                        );
                        chord.userData = {
                            type: 'primary',
                            segment: segment,
                            diameter: '0.5-1.0 mm',
                            function: 'Prevent leaflet prolapse'
                        };
                        chordaeGroup.add(chord);
                    }
                });
                
                // Secondary (strut) chordae - thick, load-bearing
                const secondaryMaterial = materialFactory(0x2563eb, { 
                    opacity: 0.8,
                    roughness: 0.3
                });
                
                segments.forEach(segment => {
                    for (let i = 0; i < 2; i++) {
                        const chord = this.createSingleChord(
                            this.getSegmentPosition(segment),
                            this.getPapillaryPosition(segment),
                            0.1, // thick diameter
                            secondaryMaterial
                        );
                        chord.userData = {
                            type: 'secondary',
                            segment: segment,
                            diameter: '1.0-2.0 mm',
                            function: 'Major load bearing (80%)'
                        };
                        chordaeGroup.add(chord);
                    }
                });
                
                // Tertiary (basal) chordae - posterior only
                const tertiaryMaterial = materialFactory(0x3b82f6, { 
                    opacity: 0.75,
                    roughness: 0.25
                });
                
                ['p1', 'p2', 'p3'].forEach(segment => {
                    const chord = this.createSingleChord(
                        this.getSegmentPosition(segment),
                        new THREE.Vector3(0, -15, 0), // Direct to LV wall
                        0.08,
                        tertiaryMaterial
                    );
                    chord.userData = {
                        type: 'tertiary',
                        segment: segment,
                        diameter: '1.0-1.5 mm',
                        function: 'LV-annular continuity'
                    };
                    chordaeGroup.add(chord);
                });
                
                this.chordaeGroups = chordaeGroup;
                parent.add(chordaeGroup);
            }
            
            createMitralAnnulus(parent, materialFactory) {
                // Create saddle-shaped annulus
                const annulusGeometry = this.createAnnulusGeometry();
                const annulusMaterial = materialFactory(0x9333ea, { 
                    opacity: 0.7,
                    roughness: 0.4
                });
                const annulusMesh = new THREE.Mesh(annulusGeometry, annulusMaterial);
                annulusMesh.name = 'mitral-annulus';
                annulusMesh.position.set(0, 5, 0);
                annulusMesh.castShadow = true;
                annulusMesh.receiveShadow = true;
                
                annulusMesh.userData = {
                    name: 'Mitral Annulus',
                    type: 'annulus',
                    circumference: '8-12 cm',
                    area: '5-11 cm¬≤',
                    shape: 'D-shaped saddle configuration',
                    dynamics: '20-30% systolic reduction',
                    function: 'Fibromuscular ring with saddle shape. Anterior portion (30%) is fibrous with aortic continuity. Posterior portion (70%) is muscular and dilates. Saddle shape reduces leaflet stress by 30%.',
                    clinical: 'Dilatation causes functional MR. MAC occurs in elderly/CKD. Loss of saddle shape increases stress. Annular abscess in endocarditis. Caseous calcification mimics tumor.',
                    surgical: 'Annuloplasty: 1) Size by anterior leaflet or intercommissural distance (28-30mm average), 2) Complete vs partial rings, 3) Rigid for functional MR, flexible preserves dynamics, 4) Saddle rings reduce stress, 5) Avoid circumflex injury.'
                };
                
                this.annulus = annulusMesh;
                parent.add(annulusMesh);
                
                // Add commissures
                const commissureMaterial = materialFactory(0xa855f7, { opacity: 0.8 });
                
                // Anterolateral commissure
                const alcGeometry = new THREE.SphereGeometry(0.6, 16, 16);
                const alcMesh = new THREE.Mesh(alcGeometry, commissureMaterial);
                alcMesh.name = 'anterolateral-commissure';
                alcMesh.position.set(-9, 4, 0);
                alcMesh.userData = {
                    name: 'Anterolateral Commissure',
                    type: 'commissure',
                    location: 'A1-P1 junction',
                    landmark: 'Left fibrous trigone'
                };
                parent.add(alcMesh);
                
                // Posteromedial commissure
                const pmcMesh = alcMesh.clone();
                pmcMesh.name = 'posteromedial-commissure';
                pmcMesh.position.set(9, 4, 0);
                pmcMesh.userData = {
                    name: 'Posteromedial Commissure',
                    type: 'commissure',
                    location: 'A3-P3 junction',
                    landmark: 'Right fibrous trigone',
                    proximity: 'Coronary sinus, AV node'
                };
                parent.add(pmcMesh);
            }
            
            createBloodFlow(parent) {
                // Create particle system for blood flow visualization
                const particleCount = 1000;
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(particleCount * 3);
                const colors = new Float32Array(particleCount * 3);
                const sizes = new Float32Array(particleCount);
                
                for (let i = 0; i < particleCount; i++) {
                    // Random position in valve area
                    const angle = Math.random() * Math.PI * 2;
                    const radius = Math.random() * 8;
                    const height = (Math.random() - 0.5) * 20;
                    
                    positions[i * 3] = Math.cos(angle) * radius;
                    positions[i * 3 + 1] = height;
                    positions[i * 3 + 2] = Math.sin(angle) * radius;
                    
                    // Red color for blood
                    colors[i * 3] = 1;
                    colors[i * 3 + 1] = 0;
                    colors[i * 3 + 2] = 0.2;
                    
                    sizes[i] = Math.random() * 0.3 + 0.1;
                }
                
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
                
                const material = new THREE.PointsMaterial({
                    size: 0.2,
                    vertexColors: true,
                    transparent: true,
                    opacity: 0.6,
                    blending: THREE.AdditiveBlending,
                    depthWrite: false
                });
                
                this.bloodFlow = new THREE.Points(geometry, material);
                this.bloodFlow.visible = false;
                parent.add(this.bloodFlow);
            }
            
            createStressVisualization(parent) {
                // Create stress heatmap overlay (simplified representation)
                // In a real application, this would use FEA data
                const stressGroup = new THREE.Group();
                stressGroup.name = 'stressVisualization';
                stressGroup.visible = false;
                
                // Add stress indicators at high-stress regions
                const stressPoints = [
                    { pos: [0, 4, 0], intensity: 0.8, label: 'A2-P2 Coaptation' },
                    { pos: [-8, 3, 0], intensity: 0.6, label: 'Anterolateral Commissure' },
                    { pos: [8, 3, 0], intensity: 0.6, label: 'Posteromedial Commissure' },
                    { pos: [0, -4, 0], intensity: 0.7, label: 'P2 Free Edge' }
                ];
                
                stressPoints.forEach(point => {
                    const geometry = new THREE.SphereGeometry(1, 16, 16);
                    const material = new THREE.MeshBasicMaterial({
                        color: new THREE.Color(1, 1 - point.intensity, 0),
                        transparent: true,
                        opacity: 0.5
                    });
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(...point.pos);
                    mesh.userData = { stressLevel: point.intensity, label: point.label };
                    stressGroup.add(mesh);
                });
                
                parent.add(stressGroup);
            }
            
            // Helper methods for geometry creation
            createLeafletSegmentGeometry(width, height, segment) {
                const geometry = new THREE.PlaneGeometry(width, height, 32, 32);
                const positions = geometry.attributes.position;
                
                // Deform to create realistic leaflet curvature
                for (let i = 0; i < positions.count; i++) {
                    const x = positions.getX(i);
                    const y = positions.getY(i);
                    
                    // Create natural curvature
                    let z = Math.sin(x / width * Math.PI) * Math.cos(y / height * Math.PI) * 2;
                    
                    // Add segment-specific deformations
                    if (segment === 'a2') {
                        z *= 1.2; // A2 is larger and more curved
                    } else if (segment === 'a1' || segment === 'a3') {
                        z *= 0.8; // Commissural segments are flatter
                    }
                    
                    positions.setZ(i, z);
                }
                
                geometry.computeVertexNormals();
                return geometry;
            }
            
            createScallopGeometry(width, height, scallop) {
                const geometry = new THREE.PlaneGeometry(width, height, 24, 24);
                const positions = geometry.attributes.position;
                
                // Create scalloped edge
                for (let i = 0; i < positions.count; i++) {
                    const x = positions.getX(i);
                    const y = positions.getY(i);
                    
                    // Scallop curvature
                    let z = Math.sin(x / width * Math.PI) * Math.cos(y / height * Math.PI * 0.5) * 1.5;
                    
                    // P2 specific modifications
                    if (scallop === 'p2') {
                        z *= 1.3; // P2 is larger
                        // Add slight billowing for myxomatous appearance
                        z += Math.sin(x / width * Math.PI * 2) * 0.3;
                    }
                    
                    positions.setZ(i, z);
                }
                
                geometry.computeVertexNormals();
                return geometry;
            }
            
            createPapillaryMuscleGeometry(type) {
                // Create realistic papillary muscle with heads
                const geometry = new THREE.CylinderGeometry(1.5, 2.5, 10, 8, 4);
                const positions = geometry.attributes.position;
                
                // Deform for organic shape
                for (let i = 0; i < positions.count; i++) {
                    const x = positions.getX(i);
                    const y = positions.getY(i);
                    const z = positions.getZ(i);
                    
                    // Add irregularity
                    const noise = (Math.random() - 0.5) * 0.2;
                    positions.setX(i, x * (1 + noise));
                    positions.setZ(i, z * (1 + noise));
                    
                    // Create heads at top
                    if (y > 3) {
                        if (type === 'posteromedial') {
                            // Bifid head for posteromedial
                            const split = x > 0 ? 0.3 : -0.3;
                            positions.setX(i, x + split);
                        }
                    }
                }
                
                geometry.computeVertexNormals();
                return geometry;
            }
            
            createSingleChord(start, end, diameter, material) {
                // Create curved chord using CatmullRom curve
                const midPoint = new THREE.Vector3(
                    (start.x + end.x) / 2 + (Math.random() - 0.5) * 2,
                    (start.y + end.y) / 2,
                    (start.z + end.z) / 2 + (Math.random() - 0.5) * 1
                );
                
                const curve = new THREE.CatmullRomCurve3([start, midPoint, end]);
                const geometry = new THREE.TubeGeometry(curve, 8, diameter, 4, false);
                return new THREE.Mesh(geometry, material);
            }
            
            createAnnulusGeometry() {
                // Create saddle-shaped annulus
                const radiusX = 12;
                const radiusY = 10;
                const points = [];
                const segments = 64;
                
                for (let i = 0; i <= segments; i++) {
                    const angle = (i / segments) * Math.PI * 2;
                    const x = Math.cos(angle) * radiusX;
                    const y = Math.sin(angle) * radiusY;
                    // Saddle shape deformation
                    const z = Math.sin(angle * 2) * 2;
                    points.push(new THREE.Vector3(x, y, z));
                }
                
                const path = new THREE.CatmullRomCurve3(points);
                path.closed = true;
                
                return new THREE.TubeGeometry(path, segments, 0.4, 8, true);
            }
            
            getSegmentPosition(segment) {
                const positions = {
                    'a1': new THREE.Vector3(-8, 3, 0),
                    'a2': new THREE.Vector3(0, 4, 0),
                    'a3': new THREE.Vector3(8, 3, 0),
                    'p1': new THREE.Vector3(-8, -3, 0),
                    'p2': new THREE.Vector3(0, -4, 0),
                    'p3': new THREE.Vector3(8, -3, 0)
                };
                return positions[segment] || new THREE.Vector3(0, 0, 0);
            }
            
            getPapillaryPosition(segment) {
                // Anterolateral PM serves A1, lateral A2, P1, lateral P2
                // Posteromedial PM serves A3, medial A2, P3, medial P2
                if (segment === 'a1' || segment === 'p1') {
                    return new THREE.Vector3(-6, -12, 2);
                } else if (segment === 'a3' || segment === 'p3') {
                    return new THREE.Vector3(6, -12, 2);
                } else {
                    // A2 and P2 receive from both
                    return Math.random() > 0.5 
                        ? new THREE.Vector3(-6, -12, 2)
                        : new THREE.Vector3(6, -12, 2);
                }
            }
            
            setupControls() {
                let isDragging = false;
                let previousPosition = { x: 0, y: 0 };
                
                const canvas = this.renderer.domElement;
                
                canvas.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    previousPosition = { x: e.clientX, y: e.clientY };
                });
                
                canvas.addEventListener('mousemove', (e) => {
                    this.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                    this.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                    
                    if (isDragging && this.rotationEnabled) {
                        const deltaX = e.clientX - previousPosition.x;
                        const deltaY = e.clientY - previousPosition.y;
                        
                        if (this.mitralValve) {
                            this.mitralValve.rotation.y += deltaX * 0.005;
                            this.mitralValve.rotation.x += deltaY * 0.005;
                        }
                        
                        previousPosition = { x: e.clientX, y: e.clientY };
                    }
                    
                    this.handleHover();
                });
                
                canvas.addEventListener('mouseup', () => {
                    isDragging = false;
                });
                
                canvas.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY * 0.05;
                    this.camera.position.z = Math.max(20, Math.min(60, this.camera.position.z + delta));
                });
                
                canvas.addEventListener('click', this.handleClick.bind(this));
            }
            
            handleHover() {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const allComponents = [...Object.values(this.leafletSegments), 
                                      ...Object.values(this.papillaryMuscles),
                                      this.annulus].filter(Boolean);
                const intersects = this.raycaster.intersectObjects(allComponents);
                
                const tooltip = document.getElementById('tooltip');
                
                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    if (object.userData && object.userData.name) {
                        tooltip.querySelector('.tooltip-title').textContent = object.userData.name;
                        tooltip.querySelector('.tooltip-content').textContent = 
                            object.userData.segment ? `Segment: ${object.userData.segment}` : 
                            object.userData.type || 'Click for details';
                        
                        tooltip.classList.add('visible');
                        tooltip.style.left = (this.mouse.x * 0.5 + 0.5) * window.innerWidth + 10 + 'px';
                        tooltip.style.top = (-this.mouse.y * 0.5 + 0.5) * window.innerHeight - 50 + 'px';
                    }
                    
                    document.body.style.cursor = 'pointer';
                } else {
                    tooltip.classList.remove('visible');
                    document.body.style.cursor = 'default';
                }
            }
            
            handleClick() {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const allComponents = [...Object.values(this.leafletSegments), 
                                      ...Object.values(this.papillaryMuscles),
                                      this.annulus].filter(Boolean);
                const intersects = this.raycaster.intersectObjects(allComponents);
                
                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    this.selectComponent(object);
                }
            }
            
            selectComponent(component) {
                // Reset previous selection
                if (this.selectedComponent) {
                    this.selectedComponent.material.emissiveIntensity = 0.01;
                }
                
                this.selectedComponent = component;
                component.material.emissiveIntensity = 0.05;
                
                // Update UI
                document.querySelectorAll('.component-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const item = document.querySelector(`[data-id="${component.name}"]`);
                if (item) {
                    item.classList.add('active');
                }
                
                // Update info panel
                this.updateInfoPanel(component.userData);
                
                // Focus camera
                this.focusOnComponent(component);
                
                // Update 3D labels if visible
                if (this.labelsVisible) {
                    this.updateLabelPositions();
                }
            }
            
            updateInfoPanel(data) {
                document.getElementById('infoTitle').textContent = data.name || 'Component Details';
                document.getElementById('infoSubtitle').textContent = data.type ? 
                    `Type: ${data.type} | Segment: ${data.segment || 'N/A'}` : 
                    'Detailed anatomical and surgical information';
                
                let content = `
                    <div class="info-section">
                        <h3 class="section-title">Anatomical Measurements</h3>
                        <div class="info-grid">
                            <div class="info-card">
                                <div class="info-card-label">Dimension</div>
                                <div class="info-card-value">${data.dimension || '--'}</div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-label">Surface Area</div>
                                <div class="info-card-value">${data.surfaceArea || data.area || '--'}</div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-label">Thickness</div>
                                <div class="info-card-value">${data.thickness || '--'}</div>
                            </div>
                            <div class="info-card">
                                <div class="info-card-label">Motion Range</div>
                                <div class="info-card-value">${data.motionRange || data.dynamics || '--'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3 class="section-title">Functional Physiology</h3>
                        <p class="info-text">${data.function || 'No functional data available.'}</p>
                    </div>
                    
                    <div class="info-section">
                        <h3 class="section-title">Clinical Correlations</h3>
                        <p class="info-text">${data.clinical || 'No clinical data available.'}</p>
                    </div>
                    
                    <div class="info-section">
                        <h3 class="section-title">Surgical Considerations</h3>
                        <p class="info-text">${data.surgical || 'No surgical data available.'}</p>
                    </div>
                `;
                
                document.getElementById('infoContent').innerHTML = content;
            }
            
            focusOnComponent(component) {
                const targetPosition = new THREE.Vector3();
                component.getWorldPosition(targetPosition);
                
                const distance = 25;
                const targetCameraPosition = new THREE.Vector3(
                    targetPosition.x,
                    targetPosition.y - 20,
                    targetPosition.z + distance
                );
                
                new TWEEN.Tween(this.camera.position)
                    .to(targetCameraPosition, 1000)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .start();
                
                new TWEEN.Tween(this.camera)
                    .to({}, 1000)
                    .onUpdate(() => {
                        this.camera.lookAt(targetPosition);
                    })
                    .start();
            }
            
            setupEventListeners() {
                // Window resize
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                // Search functionality
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const search = e.target.value.toLowerCase();
                    document.querySelectorAll('.component-item').forEach(item => {
                        const name = item.querySelector('.component-name').textContent.toLowerCase();
                        const desc = item.querySelector('.component-description').textContent.toLowerCase();
                        item.style.display = (name.includes(search) || desc.includes(search)) ? 'flex' : 'none';
                    });
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    switch(e.key.toLowerCase()) {
                        case 'r':
                            this.toggleRotation();
                            break;
                        case 'a':
                            this.toggleAnimation();
                            break;
                        case 'l':
                            this.toggleLabels();
                            break;
                        case 'f':
                            this.toggleFlow();
                            break;
                        case 's':
                            if (e.shiftKey) {
                                this.toggleStress();
                            } else {
                                this.toggleStats();
                            }
                            break;
                        case ' ':
                            e.preventDefault();
                            this.resetView();
                            break;
                        case 'escape':
                            this.deselectAll();
                            break;
                    }
                });
            }
            
            initializeUI() {
                // Initialize tooltips
                this.initTooltips();
                
                // Initialize modal handlers
                this.initModals();
                
                // Initialize pathology handlers
                this.initPathologyControls();
                
                // Initialize simulation controls
                this.initSimulationControls();
            }
            
            initTooltips() {
                // Add hover tooltips to all interactive elements
                document.querySelectorAll('[data-tooltip]').forEach(element => {
                    element.addEventListener('mouseenter', (e) => {
                        const tooltip = document.getElementById('tooltip');
                        tooltip.querySelector('.tooltip-content').textContent = e.target.dataset.tooltip;
                        tooltip.classList.add('visible');
                    });
                    
                    element.addEventListener('mouseleave', () => {
                        document.getElementById('tooltip').classList.remove('visible');
                    });
                });
            }
            
            initModals() {
                // Close modal on escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal.active').forEach(modal => {
                            modal.classList.remove('active');
                        });
                    }
                });
                
                // Close modal on background click
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
            }
            
            initPathologyControls() {
                // Initialize pathology visualization controls
                this.pathologyStates = {
                    'normal': this.createNormalState.bind(this),
                    'p2-prolapse': this.createP2ProlapseState.bind(this),
                    'rheumatic': this.createRheumaticState.bind(this),
                    'functional': this.createFunctionalMRState.bind(this),
                    'barlow': this.createBarlowState.bind(this),
                    'endocarditis': this.createEndocarditisState.bind(this)
                };
            }
            
            initSimulationControls() {
                // Heart rate slider
                const hrSlider = document.getElementById('hrSlider');
                if (hrSlider) {
                    hrSlider.addEventListener('input', (e) => {
                        this.heartRate = parseInt(e.target.value);
                        document.getElementById('hrValue').textContent = `${this.heartRate} bpm`;
                    });
                }
            }
            
            animate() {
                requestAnimationFrame(this.animate.bind(this));
                
                const deltaTime = this.clock.getDelta();
                this.frameCount++;
                
                // Update FPS counter
                const now = performance.now();
                if (now - this.lastTime > 1000) {
                    const fps = Math.round(this.frameCount * 1000 / (now - this.lastTime));
                    document.getElementById('fps').textContent = fps;
                    document.getElementById('vertices').textContent = this.renderer.info.render.vertices;
                    document.getElementById('triangles').textContent = this.renderer.info.render.triangles;
                    document.getElementById('drawCalls').textContent = this.renderer.info.render.calls;
                    document.getElementById('memory').textContent = 
                        Math.round(performance.memory ? performance.memory.usedJSHeapSize / 1048576 : 0);
                    
                    this.frameCount = 0;
                    this.lastTime = now;
                }
                
                // Update TWEEN animations
                TWEEN.update();
                
                // Cardiac cycle animation
                if (this.animationEnabled) {
                    this.animateCardiacCycle(deltaTime);
                }
                
                // Auto-rotation
                if (this.rotationEnabled && this.mitralValve && !this.selectedComponent) {
                    this.mitralValve.rotation.y += 0.002;
                }
                
                // Blood flow animation
                if (this.flowVisualization && this.bloodFlow) {
                    this.animateBloodFlow(deltaTime);
                }
                
                // Update metrics
                if (this.frameCount % 60 === 0) {
                    this.updateHemodynamics();
                }
                
                // Update 3D label positions
                if (this.labelsVisible) {
                    this.updateLabelPositions();
                }
                
                this.renderer.render(this.scene, this.camera);
            }
            
            animateCardiacCycle(deltaTime) {
                // Calculate cardiac phase based on heart rate
                const cycleTime = 60 / this.heartRate; // seconds per beat
                this.cardiacPhase += (deltaTime / cycleTime) * Math.PI * 2;
                
                if (this.cardiacPhase > Math.PI * 2) {
                    this.cardiacPhase -= Math.PI * 2;
                }
                
                // Determine systole vs diastole
                const inSystole = this.cardiacPhase < Math.PI * 2 * this.systolicFraction;
                
                // Animate leaflets
                Object.values(this.leafletSegments).forEach(segment => {
                    if (segment) {
                        const baseRotation = segment.userData.segment?.startsWith('A') ? Math.PI / 8 : -Math.PI / 8;
                        const openAngle = inSystole ? 0 : Math.sin(this.cardiacPhase) * 0.3;
                        segment.rotation.x = baseRotation + openAngle;
                    }
                });
                
                // Animate annulus contraction
                if (this.annulus) {
                    const contractionFactor = inSystole ? 0.8 : 1.0;
                    this.annulus.scale.x = contractionFactor;
                    this.annulus.scale.y = contractionFactor;
                }
                
                // Animate papillary muscles
                Object.values(this.papillaryMuscles).forEach(pm => {
                    if (pm) {
                        const contractionHeight = inSystole ? 0.9 : 1.0;
                        pm.scale.y = contractionHeight;
                    }
                });
            }
            
            animateBloodFlow(deltaTime) {
                const positions = this.bloodFlow.geometry.attributes.position;
                
                for (let i = 0; i < positions.count; i++) {
                    let y = positions.getY(i);
                    y -= deltaTime * 10; // Flow velocity
                    
                    // Reset particles that flow out
                    if (y < -15) {
                        y = 15;
                        const angle = Math.random() * Math.PI * 2;
                        const radius = Math.random() * 6;
                        positions.setX(i, Math.cos(angle) * radius);
                        positions.setZ(i, Math.sin(angle) * radius);
                    }
                    
                    positions.setY(i, y);
                }
                
                positions.needsUpdate = true;
            }
            
            updateHemodynamics() {
                // Simulate realistic hemodynamic values
                const baseGradient = 3.0;
                const variation = Math.sin(Date.now() * 0.001) * 0.5;
                
                // Update based on pathology
                let gradientMultiplier = 1;
                let areaMultiplier = 1;
                let mrGrade = 0;
                
                switch(this.currentPathology) {
                    case 'rheumatic':
                        gradientMultiplier = 3; // Stenosis increases gradient
                        areaMultiplier = 0.5; // Reduced valve area
                        break;
                    case 'p2-prolapse':
                    case 'barlow':
                        mrGrade = 3; // Severe MR
                        break;
                    case 'functional':
                        mrGrade = 2; // Moderate MR
                        break;
                }
                
                document.getElementById('meanGradient').textContent = 
                    (baseGradient * gradientMultiplier + variation).toFixed(1);
                document.getElementById('valveArea').textContent = 
                    (4.5 * areaMultiplier + Math.random() * 0.3).toFixed(1);
                document.getElementById('laPressure').textContent = 
                    Math.round(12 + mrGrade * 3 + Math.random() * 2);
                document.getElementById('mrGrade').textContent = mrGrade;
            }
            
            updateLabelPositions() {
                // Update 3D label positions based on camera
                const labels = {
                    'label-a1': this.leafletSegments['a1-segment'],
                    'label-a2': this.leafletSegments['a2-segment'],
                    'label-a3': this.leafletSegments['a3-segment'],
                    'label-p1': this.leafletSegments['p1-segment'],
                    'label-p2': this.leafletSegments['p2-segment'],
                    'label-p3': this.leafletSegments['p3-segment'],
                    'label-apm': this.papillaryMuscles['anterolateral-pm'],
                    'label-ppm': this.papillaryMuscles['posteromedial-pm']
                };
                
                Object.entries(labels).forEach(([labelId, mesh]) => {
                    const label = document.getElementById(labelId);
                    if (label && mesh) {
                        const vector = new THREE.Vector3();
                        mesh.getWorldPosition(vector);
                        vector.project(this.camera);
                        
                        const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                        const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
                        
                        label.style.left = x + 'px';
                        label.style.top = y + 'px';
                        label.classList.toggle('visible', this.labelsVisible && vector.z < 1);
                    }
                });
            }
            
            // Control methods
            toggleRotation() {
                this.rotationEnabled = !this.rotationEnabled;
                document.getElementById('rotateBtn').classList.toggle('active');
            }
            
            toggleAnimation() {
                this.animationEnabled = !this.animationEnabled;
                document.getElementById('animateBtn').classList.toggle('active');
                this.showNotification(
                    'Cardiac Cycle ' + (this.animationEnabled ? 'Started' : 'Stopped'),
                    `Simulating at ${this.heartRate} bpm`,
                    'info'
                );
            }
            
            toggleFlow() {
                this.flowVisualization = !this.flowVisualization;
                if (this.bloodFlow) {
                    this.bloodFlow.visible = this.flowVisualization;
                }
                document.getElementById('flowBtn').classList.toggle('active');
            }
            
            toggleStress() {
                this.stressVisualization = !this.stressVisualization;
                const stressGroup = this.scene.getObjectByName('stressVisualization');
                if (stressGroup) {
                    stressGroup.visible = this.stressVisualization;
                }
                document.getElementById('stressBtn').classList.toggle('active');
            }
            
            toggleLabels() {
                this.labelsVisible = !this.labelsVisible;
                document.getElementById('labelsBtn').classList.toggle('active');
                this.updateLabelPositions();
            }
            
            toggleStats() {
                const stats = document.getElementById('statsPanel');
                stats.classList.toggle('visible');
            }
            
            resetView() {
                new TWEEN.Tween(this.camera.position)
                    .to({ x: 0, y: -30, z: 40 }, 1000)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .start();
                
                if (this.mitralValve) {
                    new TWEEN.Tween(this.mitralValve.rotation)
                        .to({ x: 0, y: 0, z: 0 }, 1000)
                        .easing(TWEEN.Easing.Quadratic.InOut)
                        .start();
                }
                
                new TWEEN.Tween(this.camera)
                    .to({}, 1000)
                    .onUpdate(() => {
                        this.camera.lookAt(0, 0, 0);
                    })
                    .start();
                
                this.deselectAll();
            }
            
            deselectAll() {
                if (this.selectedComponent) {
                    this.selectedComponent.material.emissiveIntensity = 0.01;
                    this.selectedComponent = null;
                }
                
                document.querySelectorAll('.component-item').forEach(item => {
                    item.classList.remove('active');
                });
            }
            
            showNotification(title, message, type = 'info') {
                const notification = document.getElementById('notification');
                const iconElement = notification.querySelector('.notification-icon');
                
                notification.querySelector('.notification-title').textContent = title;
                notification.querySelector('.notification-message').textContent = message;
                
                iconElement.className = `notification-icon ${type}`;
                iconElement.textContent = type === 'success' ? '‚úì' : 
                                        type === 'warning' ? '‚ö†' : 
                                        type === 'error' ? '‚úï' : '‚Ñπ';
                
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 4000);
            }
            
            // Pathology state methods
            createNormalState() {
                // Reset to normal anatomy
                this.resetPathology();
            }
            
            createP2ProlapseState() {
                // Simulate P2 prolapse
                const p2 = this.leafletSegments['p2-segment'];
                if (p2) {
                    p2.position.z += 3; // Prolapse into atrium
                    p2.rotation.x = -Math.PI / 4; // Increased angle
                }
                this.showNotification('P2 Prolapse', 'Myxomatous degeneration with chordal elongation', 'warning');
            }
            
            createRheumaticState() {
                // Simulate rheumatic changes
                Object.values(this.leafletSegments).forEach(segment => {
                    if (segment) {
                        segment.scale.y *= 0.7; // Thickening and restriction
                    }
                });
                this.showNotification('Rheumatic MS', 'Commissural fusion and leaflet thickening', 'warning');
            }
            
            createFunctionalMRState() {
                // Simulate functional MR
                if (this.annulus) {
                    this.annulus.scale.x *= 1.3;
                    this.annulus.scale.y *= 1.3;
                }
                Object.values(this.papillaryMuscles).forEach(pm => {
                    if (pm) {
                        pm.position.y -= 3; // Papillary muscle displacement
                    }
                });
                this.showNotification('Functional MR', 'Annular dilatation with restricted closure', 'warning');
            }
            
            createBarlowState() {
                // Simulate Barlow disease
                Object.values(this.leafletSegments).forEach(segment => {
                    if (segment && segment.userData.type === 'leaflet') {
                        segment.scale.x *= 1.3; // Excessive tissue
                        segment.scale.y *= 1.3;
                        segment.position.z += 2; // Billowing
                    }
                });
                this.showNotification('Barlow Disease', 'Bileaflet prolapse with excessive tissue', 'warning');
            }
            
            createEndocarditisState() {
                // Simulate endocarditis
                // Add vegetation representation (simplified)
                const vegetationGeometry = new THREE.SphereGeometry(1, 8, 8);
                const vegetationMaterial = new THREE.MeshPhysicalMaterial({
                    color: 0x8b0000,
                    roughness: 0.8,
                    opacity: 0.9
                });
                const vegetation = new THREE.Mesh(vegetationGeometry, vegetationMaterial);
                vegetation.position.set(0, 3, 2);
                vegetation.name = 'vegetation';
                this.mitralValve.add(vegetation);
                
                this.showNotification('Endocarditis', 'Vegetation on A2 segment with perforation risk', 'error');
            }
            
            resetPathology() {
                // Reset all components to normal positions
                Object.values(this.leafletSegments).forEach(segment => {
                    if (segment) {
                        segment.position.z = 0;
                        segment.scale.set(1, 1, 1);
                        segment.rotation.x = segment.userData.segment?.startsWith('A') ? Math.PI / 8 : -Math.PI / 8;
                    }
                });
                
                if (this.annulus) {
                    this.annulus.scale.set(1, 1, 1);
                }
                
                Object.values(this.papillaryMuscles).forEach(pm => {
                    if (pm) {
                        pm.position.y = -12;
                    }
                });
                
                // Remove any added pathology objects
                const vegetation = this.mitralValve.getObjectByName('vegetation');
                if (vegetation) {
                    this.mitralValve.remove(vegetation);
                }
            }
            
            // Initialize comprehensive medical databases
            initializeComponentDatabase() {
                // This would contain the full medical database
                // Already defined inline for each component
                return {};
            }
            
            initializeLearningModules() {
                return [
                    {
                        id: 'module-1',
                        title: 'Mitral Valve Anatomy Fundamentals',
                        duration: '45 minutes',
                        completed: false
                    },
                    {
                        id: 'module-2',
                        title: 'Carpentier Segmental Nomenclature',
                        duration: '30 minutes',
                        completed: false
                    },
                    {
                        id: 'module-3',
                        title: 'Pathophysiology and Classification',
                        duration: '60 minutes',
                        completed: false
                    },
                    {
                        id: 'module-4',
                        title: 'Surgical Repair Techniques',
                        duration: '90 minutes',
                        completed: false
                    },
                    {
                        id: 'module-5',
                        title: 'Intraoperative Assessment',
                        duration: '45 minutes',
                        completed: false
                    },
                    {
                        id: 'module-6',
                        title: 'Complications and Management',
                        duration: '60 minutes',
                        completed: false
                    }
                ];
            }
            
            initializeAssessmentQuestions() {
                return [
                    {
                        id: 1,
                        question: "A 55-year-old presents with severe MR. Echo shows isolated P2 prolapse with a 15mm prolapsing segment. What is the most appropriate repair technique?",
                        options: [
                            "Quadrangular resection with sliding plasty",
                            "Triangular resection with direct closure",
                            "Edge-to-edge repair alone",
                            "Mitral valve replacement"
                        ],
                        correct: 1,
                        explanation: "For limited P2 prolapse (<20mm), triangular resection with direct closure is the standard approach. This preserves maximal tissue while correcting the prolapse."
                    },
                    {
                        id: 2,
                        question: "Which papillary muscle is most vulnerable to rupture following inferior myocardial infarction?",
                        options: [
                            "Anterolateral papillary muscle",
                            "Posteromedial papillary muscle",
                            "Both equally vulnerable",
                            "Neither - chordae rupture is more common"
                        ],
                        correct: 1,
                        explanation: "The posteromedial papillary muscle has single blood supply from RCA (85%) or LCX (15%), making it vulnerable to ischemia and rupture (95% of PM ruptures)."
                    },
                    {
                        id: 3,
                        question: "What percentage of the mitral annular circumference does the anterior leaflet occupy?",
                        options: [
                            "One-third",
                            "One-half",
                            "Two-thirds",
                            "Three-quarters"
                        ],
                        correct: 0,
                        explanation: "The anterior leaflet occupies one-third of the annular circumference but accounts for two-thirds of the closing surface area."
                    }
                ];
            }
            
            initializeClinicalCases() {
                return [
                    {
                        id: 'case-1',
                        title: 'Degenerative P2 Prolapse',
                        difficulty: 'beginner',
                        patient: '62-year-old male',
                        presentation: 'Progressive dyspnea, new holosystolic murmur',
                        findings: 'Isolated P2 prolapse with 18mm segment, intact chordae',
                        question: 'What is your surgical approach?',
                        answer: 'Triangular resection with annuloplasty ring'
                    },
                    {
                        id: 'case-2',
                        title: 'Acute Papillary Muscle Rupture',
                        difficulty: 'advanced',
                        patient: '68-year-old female, Day 4 post-inferior MI',
                        presentation: 'Acute pulmonary edema, cardiogenic shock',
                        findings: 'Complete posteromedial PM rupture, flail P3 and medial P2',
                        question: 'Emergency management strategy?',
                        answer: 'IABP/ECMO support, emergency PM reimplantation vs MVR'
                    },
                    {
                        id: 'case-3',
                        title: 'Barlow Disease',
                        difficulty: 'intermediate',
                        patient: '45-year-old female',
                        presentation: 'Palpitations, severe MR on routine echo',
                        findings: 'Bileaflet prolapse, excessive tissue, multiple segments',
                        question: 'Repair strategy for complex pathology?',
                        answer: 'Multiple neochordae, possible sliding plasty, large annuloplasty ring'
                    }
                ];
            }
        }
        
        // Initialize application
        let app;
        window.addEventListener('DOMContentLoaded', () => {
            app = new MitralVisProfessional();
        });
        
        // Global UI Functions
        function togglePanel() {
            const panel = document.getElementById('navPanel');
            const arrow = document.getElementById('panelArrow');
            panel.classList.toggle('collapsed');
            arrow.textContent = panel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
        }
        
        function toggleInfoPanel() {
            const panel = document.getElementById('infoPanel');
            const arrow = document.getElementById('infoPanelArrow');
            panel.classList.toggle('collapsed');
            arrow.textContent = panel.classList.contains('collapsed') ? '‚óÄ' : '‚ñ∂';
        }
        
        function toggleGroup(groupName) {
            const group = document.getElementById(`${groupName}-group`);
            if (group) {
                group.classList.toggle('expanded');
            }
        }
        
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        function selectComponent(componentId) {
            if (app) {
                const component = app.leafletSegments[componentId] || 
                                app.papillaryMuscles[componentId] || 
                                app.annulus;
                if (component) {
                    app.selectComponent(component);
                }
            }
        }
        
        function showPathology(pathologyType) {
            if (app) {
                app.currentPathology = pathologyType;
                
                // Update UI
                document.querySelectorAll('.pathology-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Apply pathology state
                if (app.pathologyStates && app.pathologyStates[pathologyType]) {
                    app.resetPathology();
                    app.pathologyStates[pathologyType]();
                }
                
                // Update details panel
                updatePathologyDetails(pathologyType);
            }
        }
        
        function updatePathologyDetails(pathologyType) {
            const details = {
                'normal': {
                    title: 'Normal Mitral Valve',
                    description: 'Complete coaptation during systole with no regurgitation.',
                    gradient: '1-3 mmHg',
                    area: '4-6 cm¬≤',
                    coaptation: '8-10 mm',
                    tenting: '<10 mm'
                },
                'p2-prolapse': {
                    title: 'P2 Prolapse - Myxomatous Degeneration',
                    description: 'Most common site of mitral prolapse (40%). Chordal elongation or rupture causes leaflet to prolapse above annular plane.',
                    gradient: '2-4 mmHg',
                    area: 'Normal',
                    mrGrade: '3-4+',
                    jet: 'Eccentric, posterior'
                },
                'rheumatic': {
                    title: 'Rheumatic Mitral Stenosis',
                    description: 'Commissural fusion, leaflet thickening, and chordal fusion. Doming in diastole with restricted opening.',
                    gradient: '5-15 mmHg',
                    area: '1.0-1.5 cm¬≤',
                    morphology: 'Thickened, restricted',
                    wilkins: '8-12'
                },
                'functional': {
                    title: 'Functional Mitral Regurgitation',
                    description: 'Type IIIb dysfunction with restricted systolic closure. Annular dilatation and papillary muscle displacement.',
                    gradient: '2-3 mmHg',
                    area: 'Normal',
                    mrGrade: '2-3+',
                    mechanism: 'Tethering + dilatation'
                },
                'barlow': {
                    title: 'Barlow Disease',
                    description: 'Severe myxomatous degeneration with bileaflet prolapse and excessive tissue. Multiple segment involvement.',
                    gradient: '2-4 mmHg',
                    area: 'Normal',
                    mrGrade: '4+',
                    morphology: 'Thickened, redundant'
                },
                'endocarditis': {
                    title: 'Infective Endocarditis',
                    description: 'Vegetation formation with risk of embolization. Potential for leaflet perforation and acute MR.',
                    complication: 'Abscess, perforation',
                    mrGrade: 'Variable',
                    surgery: 'Urgent/emergent',
                    mortality: '15-30%'
                }
            };
            
            const data = details[pathologyType] || details['normal'];
            let html = `
                <h3 style="font-size: 18px; margin-bottom: 16px;">${data.title}</h3>
                <p style="line-height: 1.8; color: var(--text-secondary); margin-bottom: 20px;">
                    ${data.description}
                </p>
                <div class="info-grid">
            `;
            
            Object.entries(data).forEach(([key, value]) => {
                if (key !== 'title' && key !== 'description') {
                    const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                    html += `
                        <div class="info-card">
                            <div class="info-card-label">${label}</div>
                            <div class="info-card-value">${value}</div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            document.getElementById('pathology-details').innerHTML = html;
        }
        
        function setImagingView(viewType) {
            if (app) {
                app.currentView = viewType;
                
                // Update UI
                document.querySelectorAll('.imaging-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Set camera position based on view
                const views = {
                    'surgeon': { position: [0, -30, 40], target: [0, 0, 0] },
                    '4chamber': { position: [0, 0, 50], target: [0, 0, 0] },
                    'lax': { position: [50, 0, 0], target: [0, 0, 0] },
                    'sax': { position: [0, 50, 0], target: [0, 0, 0] },
                    '3dtee': { position: [0, -40, 30], target: [0, 0, 0] },
                    'bicommissural': { position: [30, -20, 30], target: [0, 0, 0] }
                };
                
                const view = views[viewType];
                if (view) {
                    new TWEEN.Tween(app.camera.position)
                        .to({ x: view.position[0], y: view.position[1], z: view.position[2] }, 1500)
                        .easing(TWEEN.Easing.Quadratic.InOut)
                        .start();
                    
                    new TWEEN.Tween(app.camera)
                        .to({}, 1500)
                        .onUpdate(() => {
                            app.camera.lookAt(...view.target);
                        })
                        .start();
                }
                
                app.showNotification(`View: ${viewType.toUpperCase()}`, 
                    'Camera position updated', 'info');
            }
        }
        
        function updateHeartRate(value) {
            if (app) {
                app.heartRate = parseInt(value);
                document.getElementById('hrValue').textContent = `${value} bpm`;
            }
        }
        
        function updateAfterload(value) {
            const level = value < 33 ? 'Low' : value < 66 ? 'Normal' : 'High';
            document.getElementById('afterloadValue').textContent = level;
        }
        
        function updatePreload(value) {
            const level = value < 33 ? 'Low' : value < 66 ? 'Normal' : 'High';
            document.getElementById('preloadValue').textContent = level;
        }
        
        function setMode(mode) {
            if (app) {
                app.mode = mode;
                
                // Update UI
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Handle mode-specific actions
                switch(mode) {
                    case 'learn':
                        showLearning();
                        break;
                    case 'assess':
                        showAssessment();
                        break;
                    case 'cases':
                        showCases();
                        break;
                    case 'explore':
                    default:
                        // Stay in explore mode
                        break;
                }
            }
        }
        
        function showLearning() {
            const modal = document.getElementById('learningModal');
            const moduleList = document.getElementById('moduleList');
            const content = document.getElementById('learningContent');
            
            // Load modules
            if (app && app.learningModules) {
                moduleList.innerHTML = app.learningModules.map(module => `
                    <li class="module-item ${module.completed ? 'completed' : ''}" 
                        onclick="loadModule('${module.id}')">
                        <div class="module-number">Module ${module.id.split('-')[1]}</div>
                        <div class="module-name">${module.title}</div>
                        <div class="module-duration">${module.duration}</div>
                    </li>
                `).join('');
            }
            
            // Load first module content
            loadModule('module-1');
            
            modal.classList.add('active');
        }
        
        function loadModule(moduleId) {
            // Update active module
            document.querySelectorAll('.module-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget?.classList.add('active');
            
            // Load module content (simplified - would load from database)
            const content = getModuleContent(moduleId);
            document.getElementById('learningContent').innerHTML = content;
        }
        
        function getModuleContent(moduleId) {
            // This would fetch actual content from database
            return `
                <div class="lesson-section">
                    <h3 class="lesson-title">Module Content</h3>
                    <p class="lesson-content">
                        Detailed educational content for ${moduleId} would be loaded here.
                        This includes text, images, interactive elements, and assessments.
                    </p>
                </div>
            `;
        }
        
        function closeLearning() {
            document.getElementById('learningModal').classList.remove('active');
        }
        
        function showAssessment() {
            const modal = document.getElementById('assessmentModal');
            const content = document.getElementById('assessmentContent');
            
            if (app && app.assessmentQuestions) {
                let currentQuestion = 0;
                
                function displayQuestion(index) {
                    const q = app.assessmentQuestions[index];
                    content.innerHTML = `
                        <div class="question-header">
                            <div class="question-progress">
                                <span class="question-number">Question ${index + 1} of ${app.assessmentQuestions.length}</span>
                                <span class="question-score">Score: 0/${app.assessmentQuestions.length}</span>
                            </div>
                        </div>
                        <div class="question-text">${q.question}</div>
                        <ul class="answer-options">
                            ${q.options.map((option, i) => `
                                <li class="answer-option" onclick="selectAnswer(${index}, ${i})">
                                    <div class="answer-indicator">${String.fromCharCode(65 + i)}</div>
                                    <div class="answer-text">${option}</div>
                                </li>
                            `).join('')}
                        </ul>
                        <div class="question-feedback" id="feedback-${index}">
                            <div class="feedback-title">Explanation</div>
                            <div class="feedback-explanation">${q.explanation}</div>
                        </div>
                        <div class="assessment-navigation">
                            <button class="nav-btn" ${index === 0 ? 'disabled' : ''} 
                                onclick="displayQuestion(${index - 1})">Previous</button>
                            <button class="nav-btn" 
                                onclick="${index < app.assessmentQuestions.length - 1 ? 
                                    `displayQuestion(${index + 1})` : 'completeAssessment()'}">
                                ${index < app.assessmentQuestions.length - 1 ? 'Next' : 'Complete'}
                            </button>
                        </div>
                    `;
                }
                
                window.displayQuestion = displayQuestion;
                window.selectAnswer = (qIndex, aIndex) => {
                    const q = app.assessmentQuestions[qIndex];
                    const options = document.querySelectorAll('.answer-option');
                    options[aIndex].classList.add(aIndex === q.correct ? 'correct' : 'incorrect');
                    document.getElementById(`feedback-${qIndex}`).classList.add('show');
                };
                
                displayQuestion(0);
            }
            
            modal.classList.add('active');
        }
        
        function closeAssessment() {
            document.getElementById('assessmentModal').classList.remove('active');
        }
        
        function showCases() {
            const modal = document.getElementById('casesModal');
            const casesList = document.getElementById('casesList');
            const content = document.getElementById('caseContent');
            
            if (app && app.clinicalCases) {
                casesList.innerHTML = app.clinicalCases.map(c => `
                    <div class="case-study-card" onclick="loadCase('${c.id}')">
                        <div class="case-study-header">
                            <div class="case-study-title">${c.title}</div>
                            <div class="case-study-difficulty difficulty-${c.difficulty}">${c.difficulty}</div>
                        </div>
                        <div class="case-study-description">${c.patient}</div>
                        <div class="case-study-meta">
                            <span>${c.presentation.split(',')[0]}</span>
                        </div>
                    </div>
                `).join('');
                
                window.loadCase = (caseId) => {
                    const caseData = app.clinicalCases.find(c => c.id === caseId);
                    if (caseData) {
                        content.innerHTML = `
                            <div class="lesson-section">
                                <h3 class="lesson-title">${caseData.title}</h3>
                                <div class="lesson-highlight">
                                    <p><strong>Patient:</strong> ${caseData.patient}</p>
                                    <p><strong>Presentation:</strong> ${caseData.presentation}</p>
                                    <p><strong>Findings:</strong> ${caseData.findings}</p>
                                </div>
                                <p class="lesson-content">
                                    <strong>Clinical Question:</strong> ${caseData.question}
                                </p>
                                <div class="lesson-highlight" style="margin-top: 24px;">
                                    <strong>Expert Answer:</strong> ${caseData.answer}
                                </div>
                            </div>
                        `;
                    }
                };
                
                // Load first case
                if (app.clinicalCases.length > 0) {
                    loadCase(app.clinicalCases[0].id);
                }
            }
            
            modal.classList.add('active');
        }
        
        function closeCases() {
            document.getElementById('casesModal').classList.remove('active');
        }
        
        // Control functions
        function toggleRotation() { app?.toggleRotation(); }
        function toggleAnimation() { app?.toggleAnimation(); }
        function toggleFlow() { app?.toggleFlow(); }
        function toggleStress() { app?.toggleStress(); }
        function toggleLabels() { app?.toggleLabels(); }
        function toggleStats() { app?.toggleStats(); }
        function resetView() { app?.resetView(); }
    </script>
</body>
</html>
